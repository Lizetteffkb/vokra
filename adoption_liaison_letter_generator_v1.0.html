<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <script>
      // Ensure default theme is LIGHT on first load; honor saved preference if present
      (function () {
        try {
          var saved = localStorage.getItem("theme");
          var init = saved ? saved : "light"; // default is light
          var html = document.documentElement;
          html.classList.remove("dark");
          html.setAttribute("data-theme", init);
          if (init === "dark") html.classList.add("dark");
        } catch (e) {}
      })();
    </script>

    <script>
      (function () {
        try {
          var saved = localStorage.getItem("theme");
          var init = saved || "light";
          var html = document.documentElement;
          // normalize
          html.classList.remove("dark");
          html.setAttribute("data-theme", init);
          if (init === "dark") html.classList.add("dark");
        } catch (e) {}
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VOKRA Adoption Follow-up Email Generator</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: #fff;
        padding: 30px;
        text-align: center;
      }
      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }
      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }
      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0;
      }
      .form-section {
        padding: 40px;
        background: #f8f9fa;
        border-right: 1px solid #e9ecef;
      }
      .output-section {
        padding: 40px;
        background: #fff;
      }
      .form-group {
        margin-bottom: 25px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #495057;
        font-size: 0.95em;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #fff;
      }
      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        transform: translateY(-1px);
      }
      .checkbox-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 10px;
      }
      .checkbox-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: #fff;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .checkbox-item:hover {
        border-color: #4caf50;
        transform: translateY(-1px);
      }
      .checkbox-item input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
        transform: scale(1.2);
      }
      .checkbox-item input[type="checkbox"]:checked + span {
        color: #4caf50;
        font-weight: 600;
      }
      .generate-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .generate-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
      }
      .output {
        background: transparent;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 25px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        line-height: normal;
        min-height: 500px;
        color: #000;
      }
      .output p {
        margin: 0 0 16px 0;
      }
      .copy-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
      }
      .copy-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(0, 123, 255, 0.3);
      }
      .copy-success {
        color: #28a745;
        text-align: center;
        margin-top: 10px;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .copy-success.show {
        opacity: 1;
      }
      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }
        .form-section {
          border-right: none;
          border-bottom: 1px solid #e9ecef;
        }
        .checkbox-group {
          grid-template-columns: 1fr;
        }
        .header h1 {
          font-size: 2em;
        }
      }
      .section-title {
        font-size: 1.3em;
        color: #4caf50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
        font-weight: 700;
      }
      .add-cat-btn {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .add-cat-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(23, 162, 184, 0.3);
      }
      .cat-section {
        background: #fff;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        position: relative;
      }
      .cat-section h3 {
        color: #4caf50;
        margin-bottom: 15px;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .remove-cat-btn {
        background: #dc3545;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .remove-cat-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
      }
      .same-as-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        padding: 8px;
        background: #e3f2fd;
        border-radius: 6px;
        font-size: 0.9em;
      }
      .same-as-checkbox input[type="checkbox"] {
        width: auto;
        margin: 0;
      }
      .search-microchip-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: 140px;
      }
      .search-microchip-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #218838, #1e7e34);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }
      .search-microchip-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .microchip-companies {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }
      .microchip-companies.show {
        display: block;
      }
      .microchip-company-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .microchip-company-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        background: #fff;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
      }
      .microchip-company-item:hover {
        border-color: #4caf50;
      }
      .microchip-company-item input[type="checkbox"],
      .microchip-company-item input[type="radio"] {
        width: auto;
        margin: 0;
        transform: scale(1.1);
      }
      .microchip-company-item input[type="text"] {
        flex: 1;
        padding: 6px 10px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        font-size: 14px;
        margin-left: 8px;
      }
      .microchip-company-item input[type="text"]:focus {
        border-color: #4caf50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
      }
      .tattoo-link {
        margin: 8px 0 0 0;
        padding: 8px;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
      }
      .tattoo-link a {
        color: #856404;
        text-decoration: none;
        font-size: 0.9em;
        font-weight: 500;
      }
      .tattoo-link a:hover {
        color: #533d03;
        text-decoration: underline;
      }
      .tattoo-details {
        display: none;
        margin-top: 10px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }
      .tattoo-details.show {
        display: block;
      }
      .tattoo-details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .tattoo-detail-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .tattoo-detail-item label {
        font-size: 0.85em;
        font-weight: 600;
        color: #495057;
      }
      .tattoo-detail-item input {
        padding: 8px 10px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        font-size: 14px;
      }
      .tattoo-detail-item input:focus {
        border-color: #4caf50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
      }
      .output strong {
        font-weight: bold;
        color: #495057;
      }
      .output .purple-bold {
        font-weight: bold;
        color: #6f42c1;
      }

      /* ===== Toast / Popup ===== */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        min-width: 240px;
        background: #fff;
        border: 2px solid #e9ecef;
        border-left-width: 6px;
        padding: 10px 14px;
        border-radius: 8px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.25s ease, transform 0.25s ease;
        font-size: 14px;
        color: #333;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast-add {
        border-left-color: #28a745;
      }
      .toast-remove {
        border-left-color: #dc3545;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(
          135deg,
          #723cd7 0%,
          #5697cc 50%,
          #6e6ad6 100%
        );
        min-height: 100vh;
        padding: 20px;
        transition: background 0.3s ease, color 0.3s ease;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: background 0.3s ease, color 0.3s ease;
      }
      .header {
        position: relative;
        background: linear-gradient(135deg, #9870dc, #7c4dcd);
        color: #fff;
        padding: 30px;
        text-align: center;
      }
      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }
      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }
      .theme-toggle {
        position: absolute;
        right: 16px;
        top: 16px;
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(3px);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 999px;
        padding: 8px 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, opacity 0.2s ease;
      }
      .theme-toggle:hover {
        transform: translateY(-1px);
        opacity: 0.95;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0;
      }
      .form-section {
        padding: 40px;
        background: #f8f9fa;
        border-right: 1px solid #e9ecef;
        transition: background 0.3s ease, color 0.3s ease;
      }
      .output-section {
        padding: 40px;
        background: #fff;
        transition: background 0.3s ease, color 0.3s ease;
      }
      .form-group {
        margin-bottom: 25px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #495057;
        font-size: 0.95em;
        transition: color 0.3s ease;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #fff;
        color: #111827;
      }
      .form-group input::placeholder {
        color: #9aa3af;
      }
      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        transform: translateY(-1px);
      }
      .checkbox-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 10px;
      }
      .checkbox-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: #fff;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .checkbox-item:hover {
        border-color: #4caf50;
        transform: translateY(-1px);
      }
      .checkbox-item input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
        transform: scale(1.2);
      }
      .checkbox-item input[type="checkbox"]:checked + span {
        color: #4caf50;
        font-weight: 600;
      }
      .toolbar {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .generate-btn,
      .reset-btn {
        flex: 1 1 160px;
        min-width: 160px;
        padding: 14px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        letter-spacing: 0.3px;
      }
      .generate-btn {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: #fff;
        text-transform: uppercase;
      }
      .generate-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
      }
      .reset-btn {
        background: linear-gradient(135deg, #9aa5b1, #6b7280);
        color: #fff;
      }
      .reset-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(107, 114, 128, 0.35);
      }
      .output {
        background: transparent;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 25px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        line-height: normal;
        min-height: 500px;
        color: #000;
        transition: background 0.3s ease, color 0.3s ease,
          border-color 0.3s ease;
      }
      .output p {
        margin: 0 0 16px 0;
      }
      .copy-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
      }
      .copy-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(0, 123, 255, 0.3);
      }
      .copy-success {
        color: #28a745;
        text-align: center;
        margin-top: 10px;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .copy-success.show {
        opacity: 1;
      }
      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }
        .form-section {
          border-right: none;
          border-bottom: 1px solid #e9ecef;
        }
        .checkbox-group {
          grid-template-columns: 1fr;
        }
        .header h1 {
          font-size: 2em;
        }
      }
      .section-title {
        font-size: 1.3em;
        color: #4caf50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
        font-weight: 700;
      }
      .add-cat-btn {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .add-cat-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(23, 162, 184, 0.3);
      }
      .cat-section {
        background: #fff;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        position: relative;
        transition: background 0.3s ease, border-color 0.3s ease;
      }
      .cat-section h3 {
        color: #4caf50;
        margin-bottom: 15px;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .remove-cat-btn {
        background: #dc3545;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .remove-cat-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
      }
      .same-as-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        padding: 8px;
        background: #e3f2fd;
        border-radius: 6px;
        font-size: 0.9em;
      }
      .same-as-checkbox input[type="checkbox"] {
        width: auto;
        margin: 0;
      }
      .search-microchip-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: 140px;
      }
      .search-microchip-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #218838, #1e7e34);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }
      .search-microchip-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .microchip-companies {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }
      .microchip-companies.show {
        display: block;
      }
      .microchip-company-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .microchip-company-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        background: #fff;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
      }
      .microchip-company-item:hover {
        border-color: #4caf50;
      }
      .microchip-company-item input[type="checkbox"],
      .microchip-company-item input[type="radio"] {
        width: auto;
        margin: 0;
        transform: scale(1.1);
      }
      .microchip-company-item input[type="text"] {
        flex: 1;
        padding: 6px 10px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        font-size: 14px;
        margin-left: 8px;
      }
      .microchip-company-item input[type="text"]:focus {
        border-color: #4caf50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
      }
      .tattoo-link {
        margin: 8px 0 0 0;
        padding: 8px;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
      }
      .tattoo-link a {
        color: #856404;
        text-decoration: none;
        font-size: 0.9em;
        font-weight: 500;
      }
      .tattoo-link a:hover {
        color: #533d03;
        text-decoration: underline;
      }
      .tattoo-details {
        display: none;
        margin-top: 10px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }
      .tattoo-details.show {
        display: block;
      }
      .tattoo-details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .tattoo-detail-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .tattoo-detail-item label {
        font-size: 0.85em;
        font-weight: 600;
        color: #495057;
      }
      .tattoo-detail-item input {
        padding: 8px 10px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        font-size: 14px;
      }
      .tattoo-detail-item input:focus {
        border-color: #4caf50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
      }
      .output strong {
        font-weight: bold;
        color: #495057;
      }
      .output .purple-bold {
        font-weight: bold;
        color: #6f42c1;
      }

      /* ------------------ Dark mode overrides ------------------ */
      body.dark {
        color: #e5e7eb;
        background: linear-gradient(135deg, #0f172a 0%, #111827 100%);
      }
      body.dark .container {
        background: #0b1220;
      }
      body.dark .header {
        background: linear-gradient(135deg, #1f2937, #0f172a);
      }
      body.dark .header p {
        opacity: 0.95;
      }
      body.dark .theme-toggle {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.25);
      }
      body.dark .form-section {
        background: #0d1117;
        border-right-color: #1f2937;
      }
      body.dark .output-section {
        background: #0b1220;
      }
      body.dark .form-group label {
        color: #e5e7eb;
      }
      body.dark .form-group input,
      body.dark .form-group select {
        background: #0b1220;
        color: #e5e7eb;
        border-color: #374151;
      }
      body.dark .form-group input::placeholder {
        color: #9ca3af;
      }
      body.dark .checkbox-item {
        background: #0b1220;
        border-color: #374151;
      }
      body.dark .cat-section {
        background: #0b1220;
        border-color: #374151;
      }
      body.dark .same-as-checkbox {
        background: #0b1220;
        border: 1px dashed #374151;
      }
      body.dark .microchip-companies {
        background: #0b1220;
        border-color: #374151;
      }
      body.dark .microchip-company-item {
        background: #0b1220;
        border-color: #374151;
      }
      body.dark .tattoo-link {
        background: #1f2937;
        border-color: #374151;
      }
      body.dark .tattoo-link a {
        color: #fbbf24;
      }
      body.dark .output {
        border-color: #374151;
        color: #e5e7eb;
      }
      body.dark .copy-btn {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      }
      body.dark .reset-btn {
        background: linear-gradient(135deg, #4b5563, #374151);
      }
      body.dark .add-cat-btn {
        background: linear-gradient(135deg, #0ea5e9, #0284c7);
      }

      /* Required field error style */
      .input-error {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15) !important;
      }
    </style>
    <style>
      /* --- No background when copying from output (light/dark safe) --- */
      #output,
      #output *,
      .output,
      .output * {
        background: transparent !important;
        background-color: transparent !important;
      }
    </style>
  
  <!-- MM/DD/YYYY segmented date inputs -->
  <style>
    .date-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 2fr;
      gap: 8px;
    }
    .date-grid input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 16px;
      background: #fff;
      color: #111827;
      transition: all 0.3s ease;
    }
    .date-grid input:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 0 3px rgba(76,175,80,.1);
      transform: translateY(-1px);
    }
    .date-grid input:disabled {
      background: #f0f0f0;
      color: #9ca3af;
      cursor: not-allowed;
      opacity: 0.6;
    }
    body.dark .date-grid input {
      background: #0b1220;
      color: #e5e7eb;
      border-color: #374151;
    }
    body.dark .date-grid input:disabled {
      background: #1a1f2e;
      color: #6b7280;
      cursor: not-allowed;
      opacity: 0.5;
    }
    .date-grid.input-error input {
      border-color: #dc3545 !important;
      box-shadow: 0 0 0 3px rgba(220,53,69,.15) !important;
    }
  </style>

</head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üê± VOKRA Adoption Follow-up</h1>
        <p>Generate personalized adoption follow-up emails</p>
        <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()">
          üåô Dark Mode
        </button>
      </div>

      <div class="main-content">
        <div class="form-section">
          <div class="form-group">
            <label for="adopterName"
              >Adopter First Name: <span style="color: #dc3545">*</span></label
            >
            <input
              type="text"
              id="adopterName"
              required
              placeholder="Enter adopter first name"
              oninput="generateEmail();" />
          </div>

          <button class="add-cat-btn" onclick="addCat()">
            ‚ûï Add Another Cat
          </button>
          <div id="catsContainer"></div>

          <div class="form-group">
            <label for="pacuDate"
              >PACU Due Date: <span style="color: #dc3545">*</span></label
            >
            <input type="date" id="pacuDate" onchange="generateEmail();"
            oninput="generateEmail();" / required>
          </div>

          <h2 class="section-title">Email Content Options</h2>
          <div class="form-group">
            <label>Include Sections:</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input
                  type="checkbox"
                  id="healthSection"
                  onchange="generateEmail();"
                  checked />
                <span>Health Reminders</span>
              </div>
              <div class="checkbox-item">
                <input
                  type="checkbox"
                  id="identificationSection"
                  onchange="generateEmail();"
                  checked />
                <span>Identification Info</span>
              </div>
              <div class="checkbox-item">
                <input
                  type="checkbox"
                  id="insuranceSection"
                  onchange="generateEmail();"
                  checked />
                <span>Insurance Info</span>
              </div>
              <div class="checkbox-item">
                <input
                  type="checkbox"
                  id="facebookSection"
                  onchange="generateEmail();"
                  checked />
                <span>Facebook Group</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="vaccineDate">Next Vaccine Due (for kittens):</label>
            <input
              type="date"
              id="vaccineDate"
              onchange="generateEmail();"
              oninput="generateEmail();" />
          </div>
          <div class="toolbar">
            <button class="reset-btn" onclick="resetForm()">‚Ü∫ Reset</button>
            <button class="generate-btn" onclick="validateAndGenerate()">
              ‚ú® Generate Email
            </button>
          </div>
        </div>

        <div class="output-section">
          <h2 class="section-title">Generated Email</h2>
          <div class="output" id="output">
            Click "Generate Email" to create your personalized adoption
            follow-up email...
          </div>
          <button class="copy-btn" onclick="copyToClipboard()">
            üìã Copy to Clipboard
          </button>
          <div class="copy-success" id="copySuccess">
            Email copied to clipboard! ‚úÖ
          </div>
        </div>
      </div>
    </div>

    <!-- Toast container -->
    <div
      id="toastContainer"
      class="toast-container"
      aria-live="polite"
      aria-atomic="true"></div>

    <script>
      let catCount = 0;

      /* ---------- Theme Toggle (persist in localStorage) ---------- */
      function applyThemeFromStorage() {
        const saved = localStorage.getItem("vokra_theme");
        const btn = document.getElementById("themeToggle");
        if (saved === "dark") {
          document.body.classList.add("dark");
          if (btn) btn.textContent = "‚òÄÔ∏è Light Mode";
        } else {
          document.body.classList.remove("dark");
          if (btn) btn.textContent = "üåô Dark Mode";
        }
      }
      function toggleTheme() {
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        localStorage.setItem("vokra_theme", isDark ? "dark" : "light");
        const btn = document.getElementById("themeToggle");
        if (btn) btn.textContent = isDark ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
      }
      document.addEventListener("DOMContentLoaded", applyThemeFromStorage);
      document.addEventListener("DOMContentLoaded", function () {
        var form = document.querySelector(".form-section");
        if (form) {
          form.addEventListener("input", function (e) {
            try {
              generateEmail();
            } catch (_e) {}
          });
          form.addEventListener("change", function (e) {
            try {
              generateEmail();
            } catch (_e) {}
          });
        }
      });

      /* ---------- Reset Form ---------- */
      function resetForm() {
        // Text inputs
        const adopter = document.getElementById("adopterName");
        if (adopter) adopter.value = "";
        
        // Date inputs - clear hidden input AND sync UI
        const pacu = document.getElementById("pacuDate");
        if (pacu) {
          pacu.value = "";
          // Sync the segmented date UI if it exists
          if (typeof window.updateDateUIFromHidden === "function") {
            window.updateDateUIFromHidden("pacuDate");
          }
        }
        
        const vaccine = document.getElementById("vaccineDate");
        if (vaccine) {
          vaccine.value = "";
          // Sync the segmented date UI if it exists
          if (typeof window.updateDateUIFromHidden === "function") {
            window.updateDateUIFromHidden("vaccineDate");
          }
        }

        // Section toggles back to checked
        const sectionIds = [
          "healthSection",
          "identificationSection",
          "insuranceSection",
          "facebookSection",
        ];
        sectionIds.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.checked = true;
        });

        // Reset cats
        const container = document.getElementById("catsContainer");
        if (container) {
          container.innerHTML = "";
        }
        // Reset global counter then add one cat silently (avoid toast)
        if (typeof catCount !== "undefined") {
          catCount = 0;
        }
        if (typeof addCat === "function") {
          try {
            addCat(true);
          } catch (e) {
            addCat();
          }
        }

        // Reset output
        const out = document.getElementById("output");
        if (out) {
          out.innerHTML =
            'Click "Generate Email" to create your personalized adoption follow-up email...';
        }
        const copy = document.getElementById("copySuccess");
        if (copy) {
          copy.classList.remove("show");
        }
      }

      /* ---------- Toast ---------- */
      function showToast(message, variant = "add") {
        const container = document.getElementById("toastContainer");
        if (!container) return;
        const toast = document.createElement("div");
        toast.className = `toast toast-${variant}`;
        toast.textContent = message;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add("show"));
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, 5000);
      }

      /* ---------- Utils ---------- */
      function startOfDay(d) {
        const x = new Date(d);
        x.setHours(0, 0, 0, 0);
        return x;
      }
      function todayStart() {
        const t = new Date();
        t.setHours(0, 0, 0, 0);
        return t;
      }
      function compareToToday(dateStr) {
        if (!dateStr) return null;
        const d = startOfDay(dateStr + "T00:00:00").getTime();
        const t = todayStart().getTime();
        return d < t ? -1 : d > t ? 1 : 0;
      }
      function addMonths(dateObj, n) {
        const d = new Date(dateObj);
        const day = d.getDate();
        d.setMonth(d.getMonth() + n);
        if (d.getDate() !== day) {
          d.setDate(0);
        }
        return d;
      }
      function addDays(dateObj, n) {
        const d = new Date(dateObj);
        d.setDate(d.getDate() + n);
        return d;
      }
      function monthsBetween(dob, ref) {
        let m =
          (ref.getFullYear() - dob.getFullYear()) * 12 +
          (ref.getMonth() - dob.getMonth());
        if (ref.getDate() < dob.getDate()) m--;
        return Math.max(0, m);
      }
      function formatDate(dateString) {
        if (!dateString) return "[Date]";
        const date = new Date(dateString + "T00:00:00");
        const months = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        const day = date.getDate();
        const month = months[date.getMonth()];
        const suffix =
          day === 1 || day === 21 || day === 31
            ? "st"
            : day === 2 || day === 22
            ? "nd"
            : day === 3 || day === 23
            ? "rd"
            : "th";
        return `${month} ${day}${suffix}`;
      }
      function absDays(a, b) {
        const A = startOfDay(a),
          B = startOfDay(b);
        return Math.round(Math.abs((B - A) / (1000 * 60 * 60 * 24)));
      }

      /* ---------- Possessives & Procedures ---------- */
      function joinPossessive(names) {
        const arr = names.filter(Boolean).map((s) => s.trim());
        if (arr.length === 0) return "your cats'";
        if (arr.length === 1) return `${arr[0]}'s`;
        if (arr.length === 2) return `${arr[0]} and ${arr[1]}'s`;
        const head = arr.slice(0, -1).join(", ");
        return `${head}, and ${arr[arr.length - 1]}'s`;
      }
      function separatePossessive(names) {
        const arr = names.filter(Boolean).map((s) => s.trim());
        if (arr.length === 0) return "your cats'";
        if (arr.length === 1) return `${arr[0]}'s`;
        if (arr.length === 2) return `${arr[0]}'s and ${arr[1]}'s`;
        const head = arr
          .slice(0, -1)
          .map((n) => `${n}'s`)
          .join(", ");
        return `${head}, and ${arr[arr.length - 1]}'s`;
      }
      function procedureForGroupByGender(group) {
        const gs = group.map((c) => c.gender).filter(Boolean);
        if (gs.length && gs.every((g) => g === "female")) return "spay";
        if (gs.length && gs.every((g) => g === "male")) return "neuter";
        return "spay/neuter";
      }
      function surgeryPhrase(group) {
        const proc = procedureForGroupByGender(group);
        const pron =
          group.length === 1
            ? group[0].gender === "female"
              ? "her"
              : group[0].gender === "male"
              ? "his"
              : "their"
            : "their";
        const suffix = group.length > 1 ? "surgeries" : "surgery";
        return `${pron} ${proc} ${suffix}`;
      }

      // Generate SmartTag timing phrase (different for adults vs kittens)
      
      // Render Tattoo ownership paragraph for 0/1/multiple cats
      function renderTattooOwnershipParagraph(cats) {
        const tattooedCats = (cats || []).filter(c => c.hasTattoo);

        if (tattooedCats.length === 0) return "";

        // Single cat: keep original tone
        if (tattooedCats.length === 1) {
          const c = tattooedCats[0];
          const phoneText = c.hospitalPhone ? ` (${c.hospitalPhone})` : "";
          const tattooText = c.tattooNumber
            ? ` (<strong class="purple-bold">${c.tattooNumber}</strong>)`
            : "";
          return `<p>If you haven't already done so, please contact <strong class="purple-bold">${c.hospitalName || "*** Animal Hospital ***"}</strong>${phoneText} where the tattoo${tattooText} was completed to change ownership of your kitty.</p>`;
        }

        // Multiple cats: merge into one sentence, list each cat for clarity
        const items = tattooedCats.map(c => {
          const name = (c.name || "[Cat]").trim();
          const num = c.tattooNumber
            ? ` (<strong class="purple-bold">${c.tattooNumber}</strong>)`
            : "";
          const hosp = c.hospitalName ? ` @ ${c.hospitalName}` : "";
          const phone = c.hospitalPhone ? ` (${c.hospitalPhone})` : "";
          return `${name}${num}${hosp}${phone}`;
        }).join(", ");

        return `<p>If you haven't already done so, please contact the hospitals where the tattoos were completed to change ownership of your <strong class="purple-bold">kitties</strong>: ${items}.</p>`;
      }

function smartTagTimingPhrase(cats) {
        // Check if all cats are adults or confirmed already spayed
        const allAdultOrSpayed = cats.every(c => 
          c.category === "adult" || c.confirmedSpayed
        );
        
        if (allAdultOrSpayed) {
          // For adult cats or already spayed cats, use "adoption"
          if (cats.length === 1) {
            const pronoun = cats[0].gender === "female" ? "her" : 
                            cats[0].gender === "male" ? "his" : "their";
            return `${pronoun} adoption`;
          } else {
            return `their adoption`;
          }
        } else {
          // For kittens needing surgery, use surgery phrase
          return surgeryPhrase(cats);
        }
      }

      /* ---------- Date helpers for 5 months ---------- */
      function isPastFiveMonths(dobStr) {
        if (!dobStr) return false;
        const dob = new Date(dobStr + "T00:00:00");
        const five = addMonths(dob, 5);
        return todayStart() > startOfDay(five);
      }

      /* ---------- Cat card UI ---------- */
      function createCatSection(index) {
        const isFirst = index === 0;
        const el = document.createElement("div");
        el.className = "cat-section";
        el.id = `cat-${index}`;
        el.innerHTML = `
          <h3>${isFirst ? "Cat 1" : `Cat ${index + 1}`}${
          !isFirst
            ? `<button class="remove-cat-btn" onclick="removeCat(${index})">Remove</button>`
            : ""
        }</h3>

          <div class="form-group">
            <label for="catName-${index}">Cat Name: <span style="color:#dc3545">*</span></label>
            <input type="text" id="catName-${index}" placeholder="Enter cat's name" onchange="updateSameAsLabels(); generateEmail();" required placeholder="Enter cat\'s name">
          </div>

          <div class="form-group">
            <label for="catGender-${index}">Cat Gender: <span style="color:#dc3545">*</span></label>
            <select id="catGender-${index}" onchange="generateEmail();" required>
              <option value="">Select gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>

          <div class="form-group">
            <label for="catDob-${index}">Date of Birth (DOB): <span style="color:#dc3545">*</span></label>
            <input type="date" id="catDob-${index}" onchange="updateFromDOB(${index}); generateEmail();" required>
            ${
              !isFirst
                ? `
              <div class="same-as-checkbox">
                <input type="checkbox" id="sameDob-${index}" onchange="copyCatDOB(${index});">
                <label for="sameDob-${index}" id="sameDobLabel-${index}">Same DOB as first cat</label>
              </div>`
                : ""
            }
            <small style="color:#6c757d;font-size:0.85em;display:block;margin-top:8px;">
              Age & spay/neuter timing are auto-calculated from DOB.
            </small>
          </div>

          <div class="form-group">
            <label for="spayNeuterDate-${index}">Spay/Neuter Due Date (auto):</label>
            <input type="date" id="spayNeuterDate-${index}" onchange="generateEmail();" oninput="generateEmail();">
            
          </div>

          <!-- Confirm spayed/neutered if age > 5 months (strictly past the 5M mark) -->
          <div class="form-group" id="spayConfirmWrap-${index}" style="display:none;">
            <div class="checkbox-item">
              <input type="checkbox" id="confirmedSpayed-${index}" onchange="handleSpayedConfirmChange(${index});">
              <span>Confirm this cat is already spayed/neutered</span>
            </div>
            <small style="display:block;color:#6c757d;margin-top:6px;">Shown because DOB indicates age &gt; 5 months.</small>
          </div>

          <div class="form-group">
            <label>Identification:</label>
            <div class="checkbox-item">
              <input type="checkbox" id="hasTattoo-${index}" onchange="toggleTattooDetails(${index}); generateEmail();">
              <span>Has tattoo/ear tag</span>
            </div>
            <div id="tattooDetails-${index}" class="tattoo-details">
              <div class="tattoo-details-grid">
                <div class="tattoo-detail-item">
                  <label for="hospitalName-${index}">Animal Hospital Name:</label>
                  <input type="text" id="hospitalName-${index}" placeholder="Enter hospital name" onchange="generateEmail();">
                </div>
                <div class="tattoo-detail-item">
                  <label for="hospitalPhone-${index}">Phone Number:</label>
                  <input type="text" id="hospitalPhone-${index}" placeholder="604-XXX-XXXX" onchange="generateEmail();" oninput="formatPhoneNumber(this);" onpaste="setTimeout(()=>formatPhoneNumber(this),10);">
                </div>
              <div class="tattoo-detail-item">
                <label for="tattooNumber-${index}">Tattoo Number:</label>
                <input type="text" id="tattooNumber-${index}" placeholder="Enter tattoo number" onchange="generateEmail();">
              </div>
              
              </div>
              <div class="tattoo-link" style="margin-top: 10px;">
                <a href="https://drive.google.com/file/d/1JNpRKjl_b5VlKgGa9dyeKouTGp-e7RIz/view?usp=sharing" target="_blank" rel="noopener">üîç Please check tattoo number on <strong style="text-decoration:underline;">BCPet Registry Tattoo Code 2024</strong></a>
              </div>
            </div>

            <div class="checkbox-item" style="margin-top:10px;">
              <input type="checkbox" id="hasMicrochip-${index}" onchange="toggleMicrochipInput(${index}); generateEmail();">
              <span>Has microchip</span>
            </div>

            <div id="microchipInputContainer-${index}" style="display:none;margin-top:10px;">
              <div style="display:flex;gap:10px;align-items:center;">
                <input type="text" id="microchipNumber-${index}" placeholder="Enter microchip number" style="flex:1;padding:8px 12px;border:2px solid #e9ecef;border-radius:6px;font-size:14px;" onchange="generateEmail(); toggleSearchButton(${index});" oninput="toggleSearchButton(${index});">
                <button id="searchButton-${index}" class="search-microchip-btn" onclick="searchMicrochip(${index})" disabled>üîç Search on AAHA</button>
              </div>

              <div id="microchipCompanies-${index}" class="microchip-companies show">
                <label>Microchip Company:</label>
                <div class="microchip-company-options">
                  <div class="microchip-company-item">
                    <input type="radio" id="smartTag-${index}" name="microchipCompany-${index}" value="smartTag" onchange="generateEmail();">
                    <span>SmartTag</span>
                  </div>
                  <div class="microchip-company-item">
                    <input type="radio" id="bcPetRegistry-${index}" name="microchipCompany-${index}" value="bcPetRegistry" onchange="generateEmail();">
                    <span>BC Pet Registry</span>
                  </div>
                  <div class="microchip-company-item">
                    <input type="radio" id="otherCompany-${index}" name="microchipCompany-${index}" value="other" onchange="toggleOtherCompanyInput(${index}); generateEmail();">
                    <span>Other:</span>
                    <input type="text" id="otherCompanyName-${index}" placeholder="Enter company name" style="display:none;" onchange="generateEmail();">
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        return el;
      }

      function addCat(silent = false) {
        const container = document.getElementById("catsContainer");
        const labelText = catCount === 0 ? "Cat 1" : `Cat ${catCount + 1}`;
        const card = createCatSection(catCount);
        container.appendChild(card);
        toggleTattooDetails(catCount);
        catCount++;
        updateSameAsLabels();
        if (!silent) {
          const isAdd = labelText !== "Cat 1";
          if (isAdd) showToast(`Added ${labelText}`, "add");
          try {
            generateEmail();
          } catch (_e) {}
        }
      }

      function removeCat(index) {
        if (index === 0) return;
        const card = document.getElementById(`cat-${index}`);
        if (card) {
          const name = document
            .getElementById(`catName-${index}`)
            ?.value?.trim();
          const label = name ? name : `Cat ${index + 1}`;
          showToast(`Removed ${label}`, "remove");
          card.remove();
          generateEmail();
        }
      }

      function updateSameAsLabels() {
        const firstName =
          document.getElementById("catName-0")?.value || "first cat";
        for (let i = 1; i < catCount; i++) {
          const label = document.getElementById(`sameDobLabel-${i}`);
          if (label) {
            label.textContent = `Same DOB as ${firstName}`;
          }
        }
      }

      function copyCatDOB(toIndex) {
        const cb = document.getElementById(`sameDob-${toIndex}`);
        if (cb?.checked) {
          const firstDob = document.getElementById("catDob-0")?.value || "";
          document.getElementById(`catDob-${toIndex}`).value = firstDob;
          updateFromDOB(toIndex);
          generateEmail();
        }
      }

      function updateFromDOB(catIndex) {
        const dobStr = document.getElementById(`catDob-${catIndex}`)?.value;
        const out = document.getElementById(`spayNeuterDate-${catIndex}`);
        const confirmedCb = document.getElementById(`confirmedSpayed-${catIndex}`);
        
        if (!dobStr) {
          if (out) {
            out.value = "";
            // Sync UI
            if (typeof window.updateDateUIFromHidden === "function") {
              window.updateDateUIFromHidden(`spayNeuterDate-${catIndex}`);
            }
          }
          updateSpayConfirmVisibility(catIndex, null);
          return;
        }
        
        const dob = new Date(dobStr + "T00:00:00");
        const spayDate = addMonths(dob, 5);
        
        // Only set spay/neuter date if NOT confirmed already spayed
        if (out && !(confirmedCb && confirmedCb.checked)) {
          out.value = spayDate.toISOString().split("T")[0];
          // Sync UI
          if (typeof window.updateDateUIFromHidden === "function") {
            window.updateDateUIFromHidden(`spayNeuterDate-${catIndex}`);
          }
        } else if (out && confirmedCb && confirmedCb.checked) {
          // If already confirmed spayed, clear the date
          out.value = "";
          // Sync UI
          if (typeof window.updateDateUIFromHidden === "function") {
            window.updateDateUIFromHidden(`spayNeuterDate-${catIndex}`);
          }
        }
        
        updateSpayConfirmVisibility(catIndex, null);

        if (catIndex === 0) {
          for (let i = 1; i < catCount; i++) {
            const cb = document.getElementById(`sameDob-${i}`);
            const targetDob = document.getElementById(`catDob-${i}`);
            if (cb && cb.checked && targetDob) {
              targetDob.value = dobStr;
              const out2 = document.getElementById(`spayNeuterDate-${i}`);
              const confirmedCb2 = document.getElementById(`confirmedSpayed-${i}`);
              const sp2 = addMonths(dob, 5);
              if (out2 && !(confirmedCb2 && confirmedCb2.checked)) {
                out2.value = sp2.toISOString().split("T")[0];
                if (typeof window.updateDateUIFromHidden === "function") {
                  window.updateDateUIFromHidden(`spayNeuterDate-${i}`);
                }
              } else if (out2 && confirmedCb2 && confirmedCb2.checked) {
                out2.value = "";
                if (typeof window.updateDateUIFromHidden === "function") {
                  window.updateDateUIFromHidden(`spayNeuterDate-${i}`);
                }
              }
              updateSpayConfirmVisibility(i, null);
            }
          }
        }
      }

      function updateSpayConfirmVisibility(catIndex, _unused) {
        const wrap = document.getElementById(`spayConfirmWrap-${catIndex}`);
        const cb = document.getElementById(`confirmedSpayed-${catIndex}`);
        const dobStr = document.getElementById(`catDob-${catIndex}`)?.value;
        
        // Get the segmented date input fields
        const mmField = document.getElementById(`spayNeuterDate-${catIndex}-mm`);
        const ddField = document.getElementById(`spayNeuterDate-${catIndex}-dd`);
        const yyyyField = document.getElementById(`spayNeuterDate-${catIndex}-yyyy`);
        
        if (!dobStr) {
          wrap.style.display = "none";
          if (cb) cb.checked = false;
          // Re-enable fields when hiding the checkbox
          if (mmField) mmField.disabled = false;
          if (ddField) ddField.disabled = false;
          if (yyyyField) yyyyField.disabled = false;
          return;
        }
        const show = isPastFiveMonths(dobStr);
        if (show) {
          wrap.style.display = "block";
          // Check current state and apply disabled accordingly
          if (cb && cb.checked) {
            if (mmField) mmField.disabled = true;
            if (ddField) ddField.disabled = true;
            if (yyyyField) yyyyField.disabled = true;
          }
        } else {
          wrap.style.display = "none";
          if (cb) cb.checked = false;
          // Re-enable fields when hiding the checkbox
          if (mmField) mmField.disabled = false;
          if (ddField) ddField.disabled = false;
          if (yyyyField) yyyyField.disabled = false;
        }
      }

      // Handle when "already spayed/neutered" checkbox is changed
      function handleSpayedConfirmChange(catIndex) {
        const cb = document.getElementById(`confirmedSpayed-${catIndex}`);
        const spayDateField = document.getElementById(`spayNeuterDate-${catIndex}`);
        
        // Get the segmented date input fields
        const mmField = document.getElementById(`spayNeuterDate-${catIndex}-mm`);
        const ddField = document.getElementById(`spayNeuterDate-${catIndex}-dd`);
        const yyyyField = document.getElementById(`spayNeuterDate-${catIndex}-yyyy`);
        
        if (cb && cb.checked) {
          // If confirmed already spayed, clear the spay/neuter date field
          if (spayDateField) {
            spayDateField.value = "";
            // Also clear the segmented date UI if it exists
            if (typeof window.updateDateUIFromHidden === "function") {
              window.updateDateUIFromHidden(`spayNeuterDate-${catIndex}`);
            }
          }
          // Disable the segmented input fields
          if (mmField) mmField.disabled = true;
          if (ddField) ddField.disabled = true;
          if (yyyyField) yyyyField.disabled = true;
        } else {
          // If unchecked, recalculate the spay/neuter date from DOB
          const dobStr = document.getElementById(`catDob-${catIndex}`)?.value;
          if (dobStr && spayDateField) {
            const dob = new Date(dobStr + "T00:00:00");
            const spayDate = addMonths(dob, 5);
            spayDateField.value = spayDate.toISOString().split("T")[0];
            // Sync the segmented date UI if it exists
            if (typeof window.updateDateUIFromHidden === "function") {
              window.updateDateUIFromHidden(`spayNeuterDate-${catIndex}`);
            }
          }
          // Re-enable the segmented input fields
          if (mmField) mmField.disabled = false;
          if (ddField) ddField.disabled = false;
          if (yyyyField) yyyyField.disabled = false;
        }
        
        generateEmail();
      }

      function toggleTattooDetails(catIndex) {
        const checkbox = document.getElementById(`hasTattoo-${catIndex}`);
        const detailsDiv = document.getElementById(`tattooDetails-${catIndex}`);
        if (!checkbox || !detailsDiv) return;
        if (checkbox.checked) {
          detailsDiv.classList.add("show");
          const input = document.getElementById(`hospitalName-${catIndex}`);
          if (input) {
            setTimeout(() => input.focus(), 100);
          }
        } else {
          detailsDiv.classList.remove("show");
          document.getElementById(`hospitalName-${catIndex}`).value = "";
          document.getElementById(`hospitalPhone-${catIndex}`).value = "";
          document.getElementById(`tattooNumber-${catIndex}`).value = "";
        }
      }

      function toggleMicrochipInput(catIndex) {
        const checkbox = document.getElementById(`hasMicrochip-${catIndex}`);
        const box = document.getElementById(
          `microchipInputContainer-${catIndex}`
        );
        const input = document.getElementById(`microchipNumber-${catIndex}`);
        const btn = document.getElementById(`searchButton-${catIndex}`);
        if (checkbox.checked) {
          box.style.display = "block";
          input.focus();
          toggleSearchButton(catIndex);
        } else {
          box.style.display = "none";
          input.value = "";
          if (btn) {
            btn.disabled = true;
          }
          const radios = document.getElementsByName(
            `microchipCompany-${catIndex}`
          );
          radios.forEach((r) => (r.checked = false));
          document.getElementById(`otherCompanyName-${catIndex}`).value = "";
          document.getElementById(
            `otherCompanyName-${catIndex}`
          ).style.display = "none";
        }
      }

      function toggleOtherCompanyInput(catIndex) {
        const r = document.getElementById(`otherCompany-${catIndex}`);
        const input = document.getElementById(`otherCompanyName-${catIndex}`);
        if (r.checked) {
          input.style.display = "block";
          input.focus();
        } else {
          input.style.display = "none";
          input.value = "";
        }
      }

      function toggleSearchButton(catIndex) {
        const input = document.getElementById(`microchipNumber-${catIndex}`);
        const btn = document.getElementById(`searchButton-${catIndex}`);
        if (input && btn) {
          btn.disabled = !(input.value.trim().length > 0);
        }
      }

      function searchMicrochip(catIndex) {
        const n = document
          .getElementById(`microchipNumber-${catIndex}`)
          .value.trim();
        if (n) {
          const now = new Date();
          const months = [
            "Jan",
            "Feb",
            "Mar",
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
          ];
          const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
          const dateString = `${months[now.getMonth()]}%20${
            days[now.getDay()]
          },%20${now.getFullYear()}`;
          const url = `https://www.aaha.org/for-veterinary-professionals/microchip-search/?microchip_id=${encodeURIComponent(
            n
          )}&date=${dateString}`;
          window.open(url, "_blank");
        }
      }

      function getAllCats() {
        const cats = [];
        for (let i = 0; i < catCount; i++) {
          const section = document.getElementById(`cat-${i}`);
          if (!section) continue;
          const name =
            document.getElementById(`catName-${i}`)?.value ||
            `[Cat ${i + 1} Name]`;
          const gender = document.getElementById(`catGender-${i}`)?.value;
          const dobStr = document.getElementById(`catDob-${i}`)?.value || "";
          const spayNeuterDate =
            document.getElementById(`spayNeuterDate-${i}`)?.value || "";
          const hasTattoo =
            document.getElementById(`hasTattoo-${i}`)?.checked || false;
          const hospitalName =
            document.getElementById(`hospitalName-${i}`)?.value || "";
          const hospitalPhone =
            document.getElementById(`hospitalPhone-${i}`)?.value || "";
          const tattooNumber = document.getElementById(`tattooNumber-${i}`)?.value || "";
          const hasMicrochip =
            document.getElementById(`hasMicrochip-${i}`)?.checked || false;
          const microchipNumber =
            document.getElementById(`microchipNumber-${i}`)?.value || "";
          const selectedCompany = document.querySelector(
            `input[name="microchipCompany-${i}"]:checked`
          );
          const smartTag = selectedCompany?.value === "smartTag";
          const bcPetRegistry = selectedCompany?.value === "bcPetRegistry";
          const otherCompany = selectedCompany?.value === "other";
          const otherCompanyName =
            document.getElementById(`otherCompanyName-${i}`)?.value || "";
          const confirmedSpayed =
            document.getElementById(`confirmedSpayed-${i}`)?.checked || false;

          let ageInMonths = 0,
            category = "adult";
          if (dobStr) {
            const dob = new Date(dobStr + "T00:00:00");
            ageInMonths = monthsBetween(dob, todayStart());
            if (ageInMonths <= 5) category = "young-kitten";
            else if (ageInMonths > 5 && ageInMonths < 12)
              category = "old-kitten";
            else category = "adult";
          }

          cats.push({
            name,
            gender,
            dobStr,
            ageInMonths,
            category,
            spayNeuterDate,
            confirmedSpayed,
            hasTattoo,
            hospitalName,
            hospitalPhone,
            tattooNumber,
            hasMicrochip,
            microchipNumber,
            microchipCompany: {
              smartTag,
              bcPetRegistry,
              otherCompany,
              otherCompanyName,
            },
            pronoun:
              gender === "female" ? "her" : gender === "male" ? "his" : "their",
            pronounCap:
              gender === "female" ? "Her" : gender === "male" ? "His" : "Their",
            catPronoun:
              gender === "female" ? "she" : gender === "male" ? "he" : "they",
          });
        }
        return cats;
      }

      /* ---------- Pronouns for missing sentence ---------- */
      function getGroupPronounSet(cats) {
        if (!cats || cats.length === 0) {
          return { subj: "they", poss: "their", goVerb: "go" };
        }
        if (cats.length === 1) {
          const c = cats[0];
          if (c.gender === "male")
            return { subj: "he", poss: "his", goVerb: "goes" };
          if (c.gender === "female")
            return { subj: "she", poss: "her", goVerb: "goes" };
          return { subj: "they", poss: "their", goVerb: "go" };
        }
        return { subj: "they", poss: "their", goVerb: "go" };
      }
      function generateMissingReturnSentence(cats) {
        const p = getGroupPronounSet(cats);
        return `In the unlikely event ${p.subj} ${p.goVerb} missing, ${p.subj} can be returned to you as soon as possible via ${p.poss} tattoo and/or microchip.`;
      }

      function fourToFourPointFiveRangeForPair(catA, catB) {
        const startA = addMonths(new Date(catA.dobStr + "T00:00:00"), 4);
        const endA = addDays(startA, 14);
        const startB = addMonths(new Date(catB.dobStr + "T00:00:00"), 4);
        const endB = addDays(startB, 14);
        const earliestStart = startA < startB ? startA : startB;
        const latestEnd = endA > endB ? endA : endB;
        return {
          startStr: earliestStart.toISOString().split("T")[0],
          endStr: latestEnd.toISOString().split("T")[0],
        };
      }

      /* ---------- Validation for required fields ---------- */
      function clearInvalid(el) {
        if (!el) return;
        el.classList.remove("input-error");
        el.setAttribute("aria-invalid", "false");
      }
      function markInvalid(el) {
        if (!el) return;
        el.classList.add("input-error");
        el.setAttribute("aria-invalid", "true");
      }
      function validateRequiredFields() {
        const missing = [];

        const adopter = document.getElementById("adopterName");
        if (!adopter || !adopter.value.trim()) {
          missing.push("Adopter First Name");
          markInvalid(adopter);
        } else {
          clearInvalid(adopter);
        }

        const pacu = document.getElementById("pacuDate");
        if (!pacu || !pacu.value) {
          missing.push("PACU Due Date");
          markInvalid(pacu);
        } else {
          clearInvalid(pacu);
        }

        for (let i = 0; i < catCount; i++) {
          const sec = document.getElementById(`cat-${i}`);
          if (!sec) continue;
          const nameEl = document.getElementById(`catName-${i}`);
          const genderEl = document.getElementById(`catGender-${i}`);
          const dobEl = document.getElementById(`catDob-${i}`);
          if (!nameEl || !nameEl.value.trim()) {
            missing.push(`Cat ${i + 1} Name`);
            markInvalid(nameEl);
          } else {
            clearInvalid(nameEl);
          }
          if (!genderEl || !genderEl.value) {
            missing.push(`Cat ${i + 1} Gender`);
            markInvalid(genderEl);
          } else {
            clearInvalid(genderEl);
          }
          if (!dobEl || !dobEl.value) {
            missing.push(`Cat ${i + 1} DOB`);
            markInvalid(dobEl);
          } else {
            clearInvalid(dobEl);
          }
        }

        if (missing.length) {
          showToast("Please fill required: " + missing.join(", "), "remove");
          const firstInvalid = document.querySelector(".input-error");
          if (firstInvalid) firstInvalid.focus();
          return false;
        }
        return true;
      }

      function validateAndGenerate() {
        if (!validateRequiredFields()) return;
        generateEmail();
      }

      /* ---------- Email generation ---------- */
      function generateEmail() {
        function isMoreThanEightMonthsFromNow(dateStr) {
          if (!dateStr) return false;
          const v = new Date(dateStr + "T00:00:00");
          const cutoff = addMonths(todayStart(), 8);
          return v > cutoff;
        }

        const adopterName =
          document.getElementById("adopterName").value || "[Adopter Name]";
        const cats = getAllCats();
        if (cats.length === 0) return;

        const pacuDate = document.getElementById("pacuDate").value;
        const vaccineDate = document.getElementById("vaccineDate").value;

        const includeHealth = document.getElementById("healthSection").checked;
        const includeIdentification = document.getElementById(
          "identificationSection"
        ).checked;
        const includeInsurance =
          document.getElementById("insuranceSection").checked;
        const includeFacebook =
          document.getElementById("facebookSection").checked;

        const catNames = cats.map((c) => c.name).join(" and ");
        const hasKittens = cats.some((c) => c.category !== "adult");

        const introLine =
          cats.length > 1
            ? `It's been a couple of weeks since you brought your new arrivals home; I hope everything is going well with ${catNames}!`
            : `It's been a couple of weeks since you brought your new arrival home, and I hope everything is going well with ${catNames}!`;

        let email = `<p style="margin:0 0 16px 0;">Hi ${adopterName},</p>
<p style="margin:0 0 16px 0;">${introLine} I am reaching out with a couple of reminders and to see if you have any questions since the adoption.</p>`;

        if (includeHealth) {
          email += `<p><strong>Health Related</strong></p>`;

          /* PACU */
          if (pacuDate) {
            const cmp = compareToToday(pacuDate);
            const names = cats.map((c) => (c.name || `[Cat]`).trim());
            const catSubject =
              cats.length > 1 ? joinPossessive(names) : `${cats[0].name}'s`;

            if (cmp > 0) {
              email += `<p>Please make sure you have booked ${catSubject} Post Adoption Checkup (PACU) with one of our partner vets, for a date on or before <strong class="purple-bold">${formatDate(
                pacuDate
              )}</strong>.</p>
<p>You will be asked to provide the Contract (Agreement) and Medical History for the PACU (sent during the contract meeting from ShelterLuv). Ask the vet if they would prefer these electronically or (hard copy) in person. To avoid any cost to you, it is critical to provide these 2 documents to the vet, at the PACU.</p>`;
            } else if (cmp === 0) {
              email += `<p>Please make sure you have booked ${catSubject} Post Adoption Checkup (PACU) with one of our partner vets, for <strong class="purple-bold">${formatDate(
                pacuDate
              )} (Today)</strong>.</p>
<p>Please bring the Contract (Agreement) and Medical History for the PACU (sent during the contract meeting from ShelterLuv). Ask the vet whether they prefer these electronically or (hard copy) in person. To avoid any cost to you, it is critical to provide these 2 documents to the vet at the PACU.</p>`;
            } else {
              email += `<p>I hope you were able to attend the Post Adoption Checkup (PACU) on <strong class="purple-bold">${formatDate(
                pacuDate
              )}</strong> with one of our partner vets and that all is well.</p>`;
            }
          }

          /* Vaccine */
          if (
            hasKittens &&
            vaccineDate &&
            !isMoreThanEightMonthsFromNow(vaccineDate)
          ) {
            const vcmp = compareToToday(vaccineDate);
            const kittens = cats.filter((c) => c.category !== "adult");
            const possessiveText = kittens.length > 1 ? "kittens'" : "kitten's";
            if (vcmp > 0) {
              email += `<p>Kitten vaccine protocol: kittens require 2 FVRCP vaccines, spaced one month apart. Your ${possessiveText} next vaccine is due: <strong class="purple-bold">${formatDate(
                vaccineDate
              )}</strong>. This will be at your cost.</p>`;
            } else if (vcmp === 0) {
              email += `<p>Kitten vaccine protocol: kittens require 2 FVRCP vaccines, spaced one month apart. Your ${possessiveText} next vaccine is due: <strong class="purple-bold">${formatDate(
                vaccineDate
              )} (Today)</strong>. This is at your cost.</p>`;
            } else {
              email += `<p>Kitten vaccine protocol: kittens require 2 FVRCP vaccines, spaced one month apart. Your ${possessiveText} second vaccine was due: <strong class="purple-bold">${formatDate(
                vaccineDate
              )}</strong>, at your cost.</p>`;
            }
          }

          /* Spay/neuter guidance */
          if (hasKittens) {
            const kittens = cats.filter((c) => c.category !== "adult");
            const kittensNeedingSurgery = kittens.filter(
              (k) => !k.confirmedSpayed
            );

            if (kittensNeedingSurgery.length > 0) {
              let surgeryText = "";
              if (kittensNeedingSurgery.length === 1) {
                const k = kittensNeedingSurgery[0];
                const procedure =
                  k.gender === "female"
                    ? "spay"
                    : k.gender === "male"
                    ? "neuter"
                    : "spay/neuter";
                surgeryText = `Your kitten will need ${k.pronoun} ${procedure}, tattoo (if applicable) and microchip insertion completed at the same partner vet that you attended for ${k.pronoun} PACU; cost is covered by adoption fees. `;
              } else {
                const onlyFem = kittensNeedingSurgery.every(
                  (c) => c.gender === "female"
                );
                const onlyMale = kittensNeedingSurgery.every(
                  (c) => c.gender === "male"
                );
                if (onlyFem) {
                  surgeryText = `Your kittens will need to be spayed, tattoos (if applicable) and microchip insertion completed at the same partner vet that you attended for their PACU; cost is covered by adoption fees. `;
                } else if (onlyMale) {
                  surgeryText = `Your kittens will need to be neutered, tattoos (if applicable) and microchip insertion completed at the same partner vet that you attended for their PACU; cost is covered by adoption fees. `;
                } else {
                  surgeryText = `Your kittens will need their spay/neuter, tattoos (if applicable) and microchip insertion completed at the same partner vet that you attended for their PACU; cost is covered by adoption fees. `;
                }
              }

              if (cats.length === 2 && kittens.length >= 1) {
                const genders = cats.map((c) => c.gender);
                if (genders.includes("male") && genders.includes("female")) {
                  surgeryText += `VOKRA policy states with a male-female pair, this should be done at <strong class="purple-bold">4 - 4.5 months of age</strong>; `;
                } else if (genders[0] === genders[1]) {
                  surgeryText += `VOKRA policy states with a same gender pair, this should be done at 5 months of age; `;
                }
              }
              const hasFemaleCats = kittensNeedingSurgery.some(
                (c) => c.gender === "female"
              );
              surgeryText += hasFemaleCats
                ? `This avoids unwanted pregnancies, and prevents other mating behaviours from occurring.`
                : `This avoids other mating behaviours from occurring.`;
              email += `<p>${surgeryText}</p>`;

              let combinedWindowRendered = false;
              if (cats.length === 2) {
                const mf =
                  cats.some((c) => c.gender === "male") &&
                  cats.some((c) => c.gender === "female");
                const bothNeed = kittensNeedingSurgery.length === 2;
                const bothHaveDOB = cats[0].dobStr && cats[1].dobStr;
                if (mf && bothNeed && bothHaveDOB) {
                  const d0 = new Date(cats[0].dobStr + "T00:00:00");
                  const d1 = new Date(cats[1].dobStr + "T00:00:00");
                  if (absDays(d0, d1) <= 7) {
                    const r = fourToFourPointFiveRangeForPair(cats[0], cats[1]);
                    email += `<p>Your kittens will be <strong class="purple-bold">4 - 4.5 months of age: ${formatDate(
                      r.startStr
                    )} to ${formatDate(
                      r.endStr
                    )}</strong>. Please note some partner vets may push back on the 4 mos of age. They know our policy, and as long as the kittens are of sufficient weight to undergo the anesthetic, they can go ahead with the surgery.</p>`;
                    combinedWindowRendered = true;
                  }
                }
              }

              if (!combinedWindowRendered) {
                const lines5m = [];
                if (kittensNeedingSurgery.length === 1) {
                  const k = kittensNeedingSurgery[0];
                  if (k.spayNeuterDate) {
                    const cmp = compareToToday(k.spayNeuterDate);
                    if (cmp > 0) {
                      lines5m.push(
                        `Your kitten will be 5 months of age on: <strong class="purple-bold">${formatDate(
                          k.spayNeuterDate
                        )}</strong>`
                      );
                    } else if (cmp === 0) {
                      lines5m.push(
                        `Your kitten is 5 months of age today: <strong class="purple-bold">${formatDate(
                          k.spayNeuterDate
                        )} (Today)</strong>`
                      );
                    }
                  }
                } else {
                  kittensNeedingSurgery.forEach((c) => {
                    if (c.spayNeuterDate) {
                      const cmp = compareToToday(c.spayNeuterDate);
                      if (cmp > 0) {
                        lines5m.push(
                          `${
                            c.name
                          } will be 5 months of age on: <strong class="purple-bold">${formatDate(
                            c.spayNeuterDate
                          )}</strong>`
                        );
                      } else if (cmp === 0) {
                        lines5m.push(
                          `${
                            c.name
                          } is 5 months of age today: <strong class="purple-bold">${formatDate(
                            c.spayNeuterDate
                          )} (Today)</strong>`
                        );
                      }
                    }
                  });
                }
                
                // FIXED: Only show vet push-back note for M-F pairs
                const isMFPair = kittensNeedingSurgery.length >= 2 &&
                  kittensNeedingSurgery.some((c) => c.gender === "male") &&
                  kittensNeedingSurgery.some((c) => c.gender === "female");
                
                if (lines5m.length > 0) {
                  let vetNote = "";
                  if (isMFPair) {
                    vetNote = " Please note some partner vets may push back on the 4 mos of age. They know our policy, and as long as the kittens are of sufficient weight to undergo the anesthetic, they can go ahead with the surgery.";
                  }
                  email += `<p>${lines5m.join("<br>")}${vetNote}</p>`;
                }
              }
            }
          }

          email += `<p>${generateVetContinuationSentence(cats)}</p>`;
        }

        /* Identification */
        if (includeIdentification) {
          email += `<p><strong>Identification</strong></p>`;
          const hasTattooedCats = cats.some((c) => c.hasTattoo);
          const hasMicrochippedCats = cats.some((c) => c.hasMicrochip);

          if (hasTattooedCats) {
            email += renderTattooOwnershipParagraph(cats);
          }

          const missingSentence = generateMissingReturnSentence(cats);
          const possessiveNames =
            cats.length === 1
              ? "your kitty's"
              : separatePossessive(cats.map((c) => (c.name || `[Cat]`).trim()));
          const idPhrase =
            cats.length === 1
              ? "identification registration is"
              : "identification registrations are";
          const procWord = procedureForGroupByGender(cats);

          if (hasMicrochippedCats) {
            const smartTagCats = cats.filter(
              (c) => c.hasMicrochip && c.microchipCompany.smartTag
            );
            const hasSmartTagCats = smartTagCats.length > 0;
            const hasBCPetOrOther = cats.some(
              (c) =>
                c.hasMicrochip &&
                (c.microchipCompany.bcPetRegistry ||
                  c.microchipCompany.otherCompany)
            );

            if (hasSmartTagCats && !hasBCPetOrOther) {
              const stPhrase = smartTagTimingPhrase(
                smartTagCats.length ? smartTagCats : cats
              );
              email += `<p>Our microchip provider SmartTag will send you an email <strong class="purple-bold">within 6 weeks of ${stPhrase}</strong> to ask you to set up an account. There is no cost for this, but it will be your method to keep your contact info up to date (see microchip program page sent during the contract meeting).</p>`;
              email += `<p>Please ensure ${possessiveNames} ${idPhrase} always kept current. ${missingSentence}</p>`;
              email += `<p>If your contact information should change in the future please contact:<br>- The vet/hospital who completed the <strong class="purple-bold">${procWord}</strong> and who has the tattoo database;<br>- The microchip provider (refer to your cat's Medical History document or your account with SmartTag/BC Pet Registry).</p>`;
            } else if (hasBCPetOrOther) {
              const bcCats = cats.filter(
                (c) => c.hasMicrochip && c.microchipCompany.bcPetRegistry
              );
              const otherCats = cats.filter(
                (c) => c.hasMicrochip && c.microchipCompany.otherCompany
              );
              if (bcCats.length > 0) {
                let pronoun;
                if (bcCats.length === 1) {
                  const cat = bcCats[0];
                  pronoun =
                    cat.gender === "female"
                      ? "her"
                      : cat.gender === "male"
                      ? "his"
                      : "their";
                } else pronoun = "their";
                email += `<p>The microchip provider BC Pet Registry has been advised of ${pronoun} change of ownership. If you need to contact them, please visit: https://www.bcpetregistry.ca<br>or call: 855-622-7722 (Business Hours), 866-303-5950 (After Hours).</p>`;
              }
              if (otherCats.length > 0) {
                otherCats.forEach((cat) => {
                  if (cat.microchipCompany.otherCompanyName) {
                    email += `<p>The microchip provider ${cat.microchipCompany.otherCompanyName} has been advised of ${cat.pronoun} change of ownership.</p>`;
                  }
                });
              }
              email += `<p>Please ensure ${possessiveNames} ${idPhrase} always kept current. ${missingSentence}</p>`;
              email += `<p>If your contact information should change in the future please contact:<br>- The vet/hospital who completed the <strong class="purple-bold">${procWord}</strong> and who has the tattoo database;<br>- The microchip provider (BC Pet Registry / SmartTag / other provider as applicable).</p>`;
            } else {
              email += `<p>Please ensure ${possessiveNames} ${idPhrase} always kept current. ${missingSentence}</p>`;
              email += `<p>If your contact information should change in the future please contact:<br>- The vet/hospital who completed the <strong class="purple-bold">${procWord}</strong> and who has the tattoo database;<br>- The microchip provider (refer to your cat's Medical History document).</p>`;
            }
          } else {
            const stPhrase = smartTagTimingPhrase(cats);
            email += `<p>Our microchip provider SmartTag will send you an email <strong class="purple-bold">within 6 weeks of ${stPhrase}</strong> to ask you to set up an account. There is no cost for this, but it will be your method to keep your contact info up to date (see microchip program page sent during the contract meeting).</p>`;
            email += `<p>Please ensure ${possessiveNames} ${idPhrase} always kept current. ${missingSentence}</p>`;
            email += `<p>If your contact information should change in the future please contact:<br>- The vet/hospital who completed the <strong class="purple-bold">${procWord}</strong> and who has the tattoo database;<br>- The microchip provider (refer to your cat's Medical History document).</p>`;
          }
        }

        if (includeInsurance) {
          email += `<p><strong>Insurance</strong></p>
<p>${catNames} may qualify for a free trial pet insurance with PetSecure. If you had previously indicated an interest in insurance, please read the information sent to you. If you are now interested, please let me know and I can send you the information. If you wish to enrol, please complete the form and bring it with you to our partner vet during the PACU. The vet will activate the insurance on your behalf.</p>`;
        }

        email += `<p>Feel free to reach out directly to adoptersupport@vokra.ca for any cat behaviour or other non-emergency questions.</p>`;

        if (includeFacebook) {
          email += `<p>Join VOKRA Alumni on Facebook (<a href="https://www.facebook.com/groups/557083514316555" target="_blank" rel="noopener">VOKRA ALUMNI | Facebook</a>) and post photos of ${catNames}!</p>`;
        }

        email += `<p>Thank you for giving ${catNames} a loving and fur-ever home!</p>`;

        document.getElementById("output").innerHTML = email;
      }

      function generateVetContinuationSentence(cats) {
        const kittens = cats.filter((c) => c.category !== "adult");
        const adults = cats.filter((c) => c.category === "adult");
        if (kittens.length === 0) {
          if (cats.length === 1) {
            return `You are welcome to, but there is no obligation for you to continue to attend this vet after ${cats[0].pronoun} PACU.`;
          } else {
            return `You are welcome to, but there is no obligation for you to continue to attend this vet after their PACU.`;
          }
        }
        let surgeryText = "";
        if (adults.length === 0) {
          if (kittens.length === 1) {
            const k = kittens[0];
            const procedure =
              k.gender === "female"
                ? "spay"
                : k.gender === "male"
                ? "neuter"
                : "spay/neuter";
            surgeryText = `${k.pronoun} PACU/${procedure} surgery`;
          } else {
            const hasF = kittens.some((c) => c.gender === "female");
            const hasM = kittens.some((c) => c.gender === "male");
            if (hasF && hasM) surgeryText = `their PACU/spay/neuter surgery`;
            else if (hasF && !hasM) surgeryText = `their PACU/spay surgery`;
            else if (!hasF && hasM) surgeryText = `their PACU/neuter surgery`;
            else surgeryText = `their PACU/spay/neuter surgery`;
          }
          return `You are welcome to, but there is no obligation for you to continue to attend this vet after ${surgeryText}.`;
        }
        const hasF = kittens.some((c) => c.gender === "female");
        const hasM = kittens.some((c) => c.gender === "male");
        if (hasF && hasM) surgeryText = `their PACU/spay/neuter surgery`;
        else if (hasF && !hasM) surgeryText = `their PACU/spay surgery`;
        else if (!hasF && hasM) surgeryText = `their PACU/neuter surgery`;
        else surgeryText = `their PACU/spay/neuter surgery`;
        return `You are welcome to, but there is no obligation for you to continue to attend this vet after ${surgeryText}.`;
      }

      function formatPhoneNumber(input) {
        let digits = input.value.replace(/\D/g, "");
        if (digits.length === 11 && digits.startsWith("1"))
          digits = digits.substring(1);
        if (digits.length === 10) {
          input.value = `(${digits.substring(0, 3)}) ${digits.substring(
            3,
            6
          )}-${digits.substring(6)}`;
        } else if (digits.length === 7) {
          input.value = `${digits.substring(0, 3)}-${digits.substring(3)}`;
        }
      }

      function copyToClipboard() {
        const output = document.getElementById("output");
        const range = document.createRange();
        const sel = window.getSelection();
        sel.removeAllRanges();
        range.selectNodeContents(output);
        sel.addRange(range);
        try {
          const ok = document.execCommand("copy");
          sel.removeAllRanges();
          const msg = document.getElementById("copySuccess");
          msg.textContent = ok
            ? "Formatted email copied to clipboard! ‚úÖ"
            : "Please manually select and copy the text above.";
          msg.classList.add("show");
          msg.style.color = ok ? "#28a745" : "#dc3545";
          setTimeout(() => {
            msg.classList.remove("show");
            if (!ok) msg.style.color = "#28a745";
          }, 3000);
        } catch (e) {
          sel.removeAllRanges();
          const msg = document.getElementById("copySuccess");
          msg.textContent = "Please manually select and copy the text above.";
          msg.style.color = "#dc3545";
          msg.classList.add("show");
          setTimeout(() => {
            msg.classList.remove("show");
            msg.style.color = "#28a745";
          }, 5000);
        }
      }

      document
        .getElementById("adopterName")
        .addEventListener("input", generateEmail);
      document.addEventListener("DOMContentLoaded", function () {
        addCat(true);
        try {
          generateEmail();
        } catch (_e) {}
      });

      document.addEventListener("DOMContentLoaded", function () {
        const container = document.getElementById("catsContainer");
        const hasCat = container && container.querySelector(".cat-section");
        if (!hasCat && typeof addCat === "function") {
          try {
            addCat(true);
          } catch (e) {
            addCat();
          }
        }
        try {
          applyThemeFromStorage();
        } catch (_e) {}
      });
    </script>

    <script>
      async function copyToClipboard() {
        const output = document.getElementById("output");
        if (!output) return;

        const clone = output.cloneNode(true);

        const parseRGB = (c) => {
          if (!c) return null;
          const m = c.match(
            /rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([.\d]+))?\)/i
          );
          if (!m) return null;
          return [
            parseInt(m[1]),
            parseInt(m[2]),
            parseInt(m[3]),
            m[4] ? parseFloat(m[4]) : 1,
          ];
        };

        const nearWhite = ([r, g, b]) => r > 235 && g > 235 && b > 235;
        const nearBlack = ([r, g, b]) => r < 30 && g < 30 && b < 30;

        const isColored = ([r, g, b]) => {
          const maxv = Math.max(r, g, b),
            minv = Math.min(r, g, b);
          return maxv - minv >= 26;
        };

        const probe = output.cloneNode(true);
        const wrap = document.createElement("div");
        wrap.style.all = "initial";
        wrap.style.color = "#111";
        wrap.style.position = "fixed";
        wrap.style.left = "-9999px";
        wrap.style.top = "-9999px";
        wrap.appendChild(probe);
        document.body.appendChild(wrap);
        const rootColor = getComputedStyle(probe).color;
        const rootRGB = parseRGB(rootColor) || [17, 17, 17, 1];

        const ow = document.createTreeWalker(
          output,
          NodeFilter.SHOW_ELEMENT,
          null
        );
        const cw = document.createTreeWalker(
          clone,
          NodeFilter.SHOW_ELEMENT,
          null
        );

        const process = (origEl, cloneEl) => {
          if (cloneEl.style) {
            cloneEl.style.background = "";
            cloneEl.style.backgroundColor = "";
          }
          cloneEl.removeAttribute && cloneEl.removeAttribute("bgcolor");
          cloneEl.removeAttribute && cloneEl.removeAttribute("class");

          try {
            const cs = getComputedStyle(origEl);
            const rgb = parseRGB(cs && cs.color);
            if (rgb) {
              if (isColored(rgb) && !nearWhite(rgb) && !nearBlack(rgb)) {
                cloneEl.style &&
                  (cloneEl.style.color = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`);
              } else {
                if (cloneEl.style) {
                  cloneEl.style.removeProperty("color");
                }
              }
            }
          } catch (e) {}
        };

        process(output, clone);

        while (true) {
          const a = ow.nextNode();
          const b = cw.nextNode();
          if (!a || !b) break;
          process(a, b);
        }

        document.body.removeChild(wrap);

        const tmp = document.createElement("div");
        tmp.appendChild(clone);

        let cleanHtml = tmp.innerHTML;
        cleanHtml = cleanHtml.replace(
          /background(?:-color)?:\s*[^;"]+;?/gi,
          ""
        );
        cleanHtml = cleanHtml.replace(
          /color:\s*rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([.\d]+))?\)\s*;?/gi,
          (m, r, g, b, a) => {
            const R = parseInt(r),
              G = parseInt(g),
              B = parseInt(b);
            const maxv = Math.max(R, G, B),
              minv = Math.min(R, G, B);
            const colored = maxv - minv >= 26;
            const white = R > 235 && G > 235 && B > 235;
            const black = R < 30 && G < 30 && B < 30;
            return colored && !white && !black ? m : "";
          }
        );

        const plainText = tmp.textContent.replace(/\n{3,}/g, "\n\n").trim();

        try {
          if (navigator.clipboard && window.ClipboardItem) {
            const data = {
              "text/html": new Blob([cleanHtml], { type: "text/html" }),
              "text/plain": new Blob([plainText], { type: "text/plain" }),
            };
            await navigator.clipboard.write([new ClipboardItem(data)]);
          } else {
            const shadow = document.createElement("div");
            shadow.contentEditable = "true";
            shadow.style.position = "fixed";
            shadow.style.opacity = "0";
            shadow.style.pointerEvents = "none";
            shadow.innerHTML = cleanHtml;
            document.body.appendChild(shadow);

            const range = document.createRange();
            range.selectNodeContents(shadow);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
            document.execCommand("copy");
            sel.removeAllRanges();
            shadow.remove();
          }

          const msg = document.getElementById("copySuccess");
          if (msg) {
            msg.textContent = "Formatted email copied to clipboard! ‚úÖ";
            msg.style.color = "#28a745";
            msg.classList.add("show");
            setTimeout(() => msg.classList.remove("show"), 3000);
          }
        } catch (e) {
          const msg = document.getElementById("copySuccess");
          if (msg) {
            msg.textContent = "Please manually select and copy the text above.";
            msg.style.color = "#dc3545";
            msg.classList.add("show");
            setTimeout(() => {
              msg.classList.remove("show");
              msg.style.color = "#28a745";
            }, 5000);
          }
        }
      }
    </script>
  
<!-- Segmented Date Inputs Enhancement -->
<script>
(function() {
  const pad2 = (n) => (n > 0 && n < 10 ? "0" + n : String(n));
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
  const isLeap = (y) => (y%4===0 && y%100!==0) || (y%400===0);
  function daysInMonth(y, m) {
    if (!y || !m) return 31;
    return [31, (isLeap(y)?29:28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][m-1];
  }
  function ensureOptionList(id, from, to) {
    const prev = document.getElementById(id);
    if (prev) return prev;
    const dl = document.createElement("datalist");
    dl.id = id;
    for (let i = from; i <= to; i++) {
      const opt = document.createElement("option");
      opt.value = String(i);
      dl.appendChild(opt);
    }
    document.body.appendChild(dl);
    return dl;
  }
  function parseISO(iso) {
    if (!iso) return null;
    const m = /(\d{4})-(\d{2})-(\d{2})/.exec(iso);
    if (!m) return null;
    return { y: +m[1], m: +m[2], d: +m[3] };
  }
  function toISO(y, m, d) {
    if (!y || !m || !d) return "";
    return `${y}-${pad2(m)}-${pad2(d)}`;
  }
  function sanitizeNum(str) {
    if (!str) return null;
    const v = parseInt(String(str).replace(/[^\d]/g, ""), 10);
    return Number.isFinite(v) ? v : null;
  }
  function updateDayDatalist(baseId, y, m) {
    const max = daysInMonth(y, m);
    const ddListId = `${baseId}-dd-list`;
    let dl = document.getElementById(ddListId);
    if (dl) dl.remove();
    dl = ensureOptionList(ddListId, 1, max);
    const dd = document.getElementById(`${baseId}-dd`);
    if (dd) dd.setAttribute("list", ddListId);
  }
  function reflectHiddenToUI(baseId) {
    const hidden = document.getElementById(baseId);
    const mm = document.getElementById(`${baseId}-mm`);
    const dd = document.getElementById(`${baseId}-dd`);
    const yy = document.getElementById(`${baseId}-yyyy`);
    if (!hidden || !mm || !dd || !yy) return;
    const v = parseISO(hidden.value);
    if (v) {
      yy.value = String(v.y);
      mm.value = String(v.m);
      updateDayDatalist(baseId, v.y, v.m);
      dd.value = String(v.d);
    } else {
      yy.value = "";
      mm.value = "";
      updateDayDatalist(baseId, new Date().getFullYear(), 1);
      dd.value = "";
    }
  }
  function updateHiddenFromUI(baseId, trigger = true) {
    const hidden = document.getElementById(baseId);
    const mm = document.getElementById(`${baseId}-mm`);
    const dd = document.getElementById(`${baseId}-dd`);
    const yy = document.getElementById(`${baseId}-yyyy`);
    if (!hidden || !mm || !dd || !yy) return;
    let y = sanitizeNum(yy.value);
    let m = sanitizeNum(mm.value);
    if (m) m = clamp(m, 1, 12);
    updateDayDatalist(baseId, y || new Date().getFullYear(), m || 1);
    let d = sanitizeNum(dd.value);
    const maxD = daysInMonth(y || new Date().getFullYear(), m || 1);
    if (d) d = clamp(d, 1, maxD);
    yy.value = y ? String(y) : "";
    mm.value = m ? String(m) : "";
    dd.value = d ? String(d) : "";
    const iso = (y && m && d) ? toISO(y, m, d) : "";
    const prev = hidden.value;
    hidden.value = iso;
    const wrap = document.getElementById(`${baseId}-wrap`);
    if (wrap) {
      if (iso) wrap.classList.remove("input-error");
    }
    if (trigger && prev !== iso) {
      try { hidden.dispatchEvent(new Event("input", {bubbles:true})); } catch(e){}
      try { hidden.dispatchEvent(new Event("change", {bubbles:true})); } catch(e){}
      try { if (typeof generateEmail==="function") generateEmail(); } catch(e){}
    }
  }
  window.enhanceDateInput = function(baseId, opts = {}) {
    const hidden = document.getElementById(baseId);
    if (!hidden || hidden.dataset.enhanced === "1") return;
    let initVal = hidden.value;
    try { if (hidden.type && hidden.type.toLowerCase() === "date") initVal = hidden.value; } catch(e){}
    hidden.type = "hidden";
    hidden.dataset.enhanced = "1";
    if (initVal) hidden.value = initVal;

    const wrap = document.createElement("div");
    wrap.className = "date-grid";
    wrap.id = `${baseId}-wrap`;

    const mm = document.createElement("input");
    mm.id = `${baseId}-mm`;
    mm.setAttribute("inputmode", "numeric");
    mm.setAttribute("placeholder", "MM");
    mm.setAttribute("maxlength", "2");
    mm.setAttribute("list", `${baseId}-mm-list`);
    ensureOptionList(`${baseId}-mm-list`, 1, 12);

    const dd = document.createElement("input");
    dd.id = `${baseId}-dd`;
    dd.setAttribute("inputmode", "numeric");
    dd.setAttribute("placeholder", "DD");
    dd.setAttribute("maxlength", "2");
    ensureOptionList(`${baseId}-dd-list`, 1, 31);
    dd.setAttribute("list", `${baseId}-dd-list`);

    const yy = document.createElement("input");
    yy.id = `${baseId}-yyyy`;
    yy.setAttribute("inputmode", "numeric");
    yy.setAttribute("placeholder", "YYYY");
    yy.setAttribute("maxlength", "4");

    [mm, dd, yy].forEach(el => {
      el.addEventListener("input", () => updateHiddenFromUI(baseId, true));
      el.addEventListener("change", () => updateHiddenFromUI(baseId, true));
      el.addEventListener("blur", () => updateHiddenFromUI(baseId, true));
    });
    if (opts.readOnly) {
      [mm, dd, yy].forEach(el => el.readOnly = true);
    }

    wrap.appendChild(mm);
    wrap.appendChild(dd);
    wrap.appendChild(yy);
    hidden.insertAdjacentElement("afterend", wrap);
    reflectHiddenToUI(baseId);
  };
  window.updateDateUIFromHidden = function(baseId) { reflectHiddenToUI(baseId); };

  const oldMarkInvalid = window.markInvalid;
  const oldClearInvalid = window.clearInvalid;
  window.markInvalid = function(el) {
    if (el) {
      const wrap = document.getElementById(`${el.id}-wrap`);
      if (wrap) { wrap.classList.add("input-error"); return; }
    }
    if (typeof oldMarkInvalid === "function") oldMarkInvalid(el);
  };
  window.clearInvalid = function(el) {
    if (el) {
      const wrap = document.getElementById(`${el.id}-wrap`);
      if (wrap) { wrap.classList.remove("input-error"); return; }
    }
    if (typeof oldClearInvalid === "function") oldClearInvalid(el);
  };

  function patchFunction(name, after) {
    if (typeof window[name] === "function") {
      const _orig = window[name];
      window[name] = function() {
        const r = _orig.apply(this, arguments);
        try { after.apply(this, arguments); } catch(e){}
        return r;
      };
    }
  }
  patchFunction("updateFromDOB", function(index) {
    if (typeof index === "number") {
      if (document.getElementById(`spayNeuterDate-${index}`)) {
        updateDateUIFromHidden(`spayNeuterDate-${index}`);
      }
      if (document.getElementById(`catDob-${index}`) && !document.getElementById(`catDob-${index}-wrap`)) {
        enhanceDateInput(`catDob-${index}`);
      }
    }
  });
  patchFunction("addCat", function() {
    const maybe = (window.catCount != null) ? (window.catCount - 1) : null;
    if (maybe != null) {
      if (document.getElementById(`catDob-${maybe}`)) enhanceDateInput(`catDob-${maybe}`);
      if (document.getElementById(`spayNeuterDate-${maybe}`)) enhanceDateInput(`spayNeuterDate-${maybe}`, { readOnly: true });
    }
  });
  patchFunction("createCatSection", function(index) {
    if (typeof index === "number") {
      if (document.getElementById(`catDob-${index}`)) enhanceDateInput(`catDob-${index}`);
      if (document.getElementById(`spayNeuterDate-${index}`)) enhanceDateInput(`spayNeuterDate-${index}`);
    }
  });

  const obs = new MutationObserver((mutations) => {
    for (const m of mutations) {
      for (const node of m.addedNodes) {
        if (!(node instanceof HTMLElement)) continue;
        const inputs = node.querySelectorAll ? node.querySelectorAll("input[id]") : [];
        inputs.forEach((el) => {
          if (/^(catDob|spayNeuterDate)-(\d+)$/.test(el.id)) {
            if (el.id.startsWith("catDob-")) enhanceDateInput(el.id);
            if (el.id.startsWith("spayNeuterDate-")) enhanceDateInput(el.id);
          }
        });
      }
    }
  });
  obs.observe(document.documentElement, { childList: true, subtree: true });

  document.addEventListener("DOMContentLoaded", function () {
    if (document.getElementById("pacuDate")) enhanceDateInput("pacuDate");
    if (document.getElementById("vaccineDate")) enhanceDateInput("vaccineDate");
  });

})();
</script>

</body>
</html>

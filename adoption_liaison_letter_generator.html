<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VOKRA Adoption Follow-up Email Generator</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0;
      }

      .form-section {
        padding: 40px;
        background: #f8f9fa;
        border-right: 1px solid #e9ecef;
      }

      .output-section {
        padding: 40px;
        background: white;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #495057;
        font-size: 0.95em;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: white;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        transform: translateY(-1px);
      }

      .checkbox-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 10px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: white;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .checkbox-item:hover {
        border-color: #4caf50;
        transform: translateY(-1px);
      }

      .checkbox-item input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
        transform: scale(1.2);
      }

      .checkbox-item input[type="checkbox"]:checked + span {
        color: #4caf50;
        font-weight: 600;
      }

      .generate-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 20px;
      }

      .generate-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
      }

      .output {
        background: transparent;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 25px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        line-height: normal;
        min-height: 500px;
        color: #000000;
      }

      .output p {
        margin: 0 0 16px 0;
      }

      .output p:last-child {
        margin-bottom: 0;
      }

      .copy-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
      }

      .copy-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(0, 123, 255, 0.3);
      }

      .copy-success {
        color: #28a745;
        text-align: center;
        margin-top: 10px;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .copy-success.show {
        opacity: 1;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .form-section {
          border-right: none;
          border-bottom: 1px solid #e9ecef;
        }

        .checkbox-group {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2em;
        }
      }

      .section-title {
        font-size: 1.3em;
        color: #4caf50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
        font-weight: 700;
      }

      .add-cat-btn {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .add-cat-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(23, 162, 184, 0.3);
      }

      .cat-section {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        position: relative;
      }

      .cat-section h3 {
        color: #4caf50;
        margin-bottom: 15px;
        font-size: 1.1em;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .remove-cat-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .remove-cat-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
      }

      .same-as-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        padding: 8px;
        background: #e3f2fd;
        border-radius: 6px;
        font-size: 0.9em;
      }

      .same-as-checkbox input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      .search-microchip-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: 140px;
      }

      .search-microchip-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #218838, #1e7e34);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }

      .search-microchip-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .microchip-companies {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .microchip-companies.show {
        display: block;
      }

      .microchip-companies label {
        font-size: 0.9em;
        font-weight: 600;
        color: #495057;
        margin-bottom: 10px;
      }

      .microchip-company-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .microchip-company-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
      }

      .microchip-company-item:hover {
        border-color: #4caf50;
      }

      .microchip-company-item input[type="checkbox"],
      .microchip-company-item input[type="radio"] {
        width: auto;
        margin: 0;
        transform: scale(1.1);
      }

      .microchip-company-item input[type="text"] {
        flex: 1;
        padding: 6px 10px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        font-size: 14px;
        margin-left: 8px;
      }

      .microchip-company-item input[type="text"]:focus {
        border-color: #4caf50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
      }

      .microchip-company-item span {
        font-size: 0.9em;
        color: #495057;
      }

      .microchip-company-item input[type="checkbox"]:checked + span,
      .microchip-company-item input[type="radio"]:checked + span {
        color: #4caf50;
        font-weight: 600;
      }

      .tattoo-link {
        margin: 8px 0 0 34px;
        padding: 8px;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
      }

      .tattoo-link a {
        color: #856404;
        text-decoration: none;
        font-size: 0.9em;
        font-weight: 500;
      }

      .tattoo-link a:hover {
        color: #533d03;
        text-decoration: underline;
      }

      /* New styles for formatted text in output */
      .output strong {
        font-weight: bold;
        color: #495057;
      }

      .output .section-header {
        font-weight: bold;
        color: #495057;
      }

      .output .purple-bold {
        font-weight: bold;
        color: #6f42c1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üê± VOKRA Adoption Follow-up</h1>
        <p>Generate personalized adoption follow-up emails</p>
      </div>

      <div class="main-content">
        <div class="form-section">
          <div class="form-group">
            <label for="adopterName">Adopter First Name:</label>
            <input
              type="text"
              id="adopterName"
              placeholder="Enter adopter's first name" />
          </div>

          <button class="add-cat-btn" onclick="addCat()">
            ‚ûï Add Another Cat
          </button>

          <div id="catsContainer">
            <!-- First cat section will be created here -->
          </div>

          <div class="form-group">
            <label for="pacuDate">PACU Due Date:</label>
            <input type="date" id="pacuDate" />
          </div>

          <h2 class="section-title">Email Content Options</h2>

          <div class="form-group">
            <label>Include Sections:</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="healthSection" checked />
                <span>Health Reminders</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="identificationSection" checked />
                <span>Identification Info</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="insuranceSection" checked />
                <span>Insurance Info</span>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="facebookSection" checked />
                <span>Facebook Group</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="vaccineDate">Next Vaccine Due (for kittens):</label>
            <input type="date" id="vaccineDate" />
          </div>

          <button class="generate-btn" onclick="generateEmail()">
            ‚ú® Generate Email
          </button>
        </div>

        <div class="output-section">
          <h2 class="section-title">Generated Email</h2>
          <div class="output" id="output">
            Click "Generate Email" to create your personalized adoption
            follow-up email...
          </div>
          <button class="copy-btn" onclick="copyToClipboard()">
            üìã Copy to Clipboard
          </button>
          <div class="copy-success" id="copySuccess">
            Email copied to clipboard! ‚úÖ
          </div>
        </div>
      </div>
    </div>

    <script>
      let catCount = 0;

      function createCatSection(index) {
        const isFirst = index === 0;
        const catSection = document.createElement("div");
        catSection.className = "cat-section";
        catSection.id = `cat-${index}`;

        catSection.innerHTML = `
                <h3>
                    ${isFirst ? "Primary Cat" : `Cat ${index + 1}`}
                    ${
                      !isFirst
                        ? `<button class="remove-cat-btn" onclick="removeCat(${index})">Remove</button>`
                        : ""
                    }
                </h3>
                
                <div class="form-group">
                    <label for="catName-${index}">Cat Name:</label>
                    <input type="text" id="catName-${index}" placeholder="Enter cat's name" onchange="updateSameAsLabels(); generateEmail();">
                </div>
                
                <div class="form-group">
                    <label for="catGender-${index}">Cat Gender:</label>
                    <select id="catGender-${index}" onchange="generateEmail();">
                        <option value="">Select gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Cat's Current Age:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="flex: 1;">
                            <input type="number" id="catAgeYears-${index}" placeholder="0" min="0" max="20" style="text-align: center;" onchange="calculateSpayNeuterDate(${index}); generateEmail();">
                            <small style="display: block; text-align: center; color: #6c757d;">Years</small>
                        </div>
                        <div style="flex: 1;">
                            <input type="number" id="catAgeMonths-${index}" placeholder="0" min="0" max="11" style="text-align: center;" onchange="calculateSpayNeuterDate(${index}); generateEmail();">
                            <small style="display: block; text-align: center; color: #6c757d;">Months</small>
                        </div>
                        <div style="flex: 1;">
                            <input type="number" id="catAgeDays-${index}" placeholder="0" min="0" max="31" style="text-align: center;" onchange="calculateSpayNeuterDate(${index}); generateEmail();">
                            <small style="display: block; text-align: center; color: #6c757d;">Days</small>
                        </div>
                    </div>
                    <small style="color: #6c757d; font-size: 0.85em; margin-top: 8px; display: block;">
                        ‚â§5 months = Young Kitten | >5 months - 1 year = Old Kitten | >1 year = Adult Cat
                    </small>
                    
                    ${
                      !isFirst
                        ? `
                    <div class="same-as-checkbox">
                        <input type="checkbox" id="sameAge-${index}" onchange="copyCatAge(${index});">
                        <label for="sameAge-${index}" id="sameAgeLabel-${index}">Same age as first cat</label>
                    </div>
                    `
                        : ""
                    }
                </div>
                
                <div class="form-group">
                    <label for="spayNeuterDate-${index}">Spay/Neuter Due Date:</label>
                    <input type="date" id="spayNeuterDate-${index}" readonly style="background-color: #f8f9fa; color: #495057;">
                    <small style="color: #6c757d; font-size: 0.85em; margin-top: 5px; display: block;">
                        Auto-calculated: Birth date + 5 months
                    </small>
                </div>
                
                <div class="form-group">
                    <label>Identification:</label>
                    <div class="checkbox-item">
                        <input type="checkbox" id="hasTattoo-${index}" onchange="toggleTattooLink(${index}); generateEmail();">
                        <span>Has tattoo/ear tag</span>
                    </div>
                    <div id="tattooLink-${index}" style="display:none;" class="tattoo-link">
                        <a href="https://drive.google.com/file/d/1JNpRKjl_b5VlKgGa9dyeKouTGp-e7RIz/view?usp=sharing" target="_blank" rel="noopener">Please check tattoo number on BCPet Registry Tattoo Code 2024</a>
                    </div>
                    <div class="checkbox-item" style="margin-top: 10px;">
                        <input type="checkbox" id="hasMicrochip-${index}" onchange="toggleMicrochipInput(${index}); generateEmail();">
                        <span>Has microchip</span>
                    </div>
                    <div id="microchipInputContainer-${index}" style="display: none; margin-top: 10px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="microchipNumber-${index}" placeholder="Enter microchip number" style="flex: 1; padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;" onchange="generateEmail(); toggleSearchButton(${index});" oninput="toggleSearchButton(${index});">
                            <button id="searchButton-${index}" class="search-microchip-btn" onclick="searchMicrochip(${index})" disabled>
                                üîç Search on AAHA
                            </button>
                        </div>
                        
                        <div id="microchipCompanies-${index}" class="microchip-companies show">
                            <label>Microchip Company:</label>
                            <div class="microchip-company-options">
                                <div class="microchip-company-item">
                                    <input type="radio" id="smartTag-${index}" name="microchipCompany-${index}" value="smartTag" onchange="generateEmail();">
                                    <span>SmartTag</span>
                                </div>
                                <div class="microchip-company-item">
                                    <input type="radio" id="bcPetRegistry-${index}" name="microchipCompany-${index}" value="bcPetRegistry" onchange="generateEmail();">
                                    <span>BC Pet Registry</span>
                                </div>
                                <div class="microchip-company-item">
                                    <input type="radio" id="otherCompany-${index}" name="microchipCompany-${index}" value="other" onchange="toggleOtherCompanyInput(${index}); generateEmail();">
                                    <span>Other:</span>
                                    <input type="text" id="otherCompanyName-${index}" placeholder="Enter company name" style="display: none;" onchange="generateEmail();">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

        return catSection;
      }

      function addCat() {
        const container = document.getElementById("catsContainer");
        const catSection = createCatSection(catCount);
        container.appendChild(catSection);
        // initialize tattoo link visibility (hidden by default)
        toggleTattooLink(catCount);
        catCount++;
        updateSameAsLabels();
      }

      function removeCat(index) {
        const catSection = document.getElementById(`cat-${index}`);
        if (catSection) {
          catSection.remove();
          generateEmail();
        }
      }

      function updateSameAsLabels() {
        const firstName =
          document.getElementById("catName-0")?.value || "first cat";
        for (let i = 1; i < catCount; i++) {
          const label = document.getElementById(`sameAgeLabel-${i}`);
          if (label) {
            label.textContent = `Same age as ${firstName}`;
          }
        }
      }

      function copyCatAge(toIndex) {
        const checkbox = document.getElementById(`sameAge-${toIndex}`);
        if (checkbox.checked) {
          const fromYears = document.getElementById("catAgeYears-0").value;
          const fromMonths = document.getElementById("catAgeMonths-0").value;
          const fromDays = document.getElementById("catAgeDays-0").value;

          document.getElementById(`catAgeYears-${toIndex}`).value = fromYears;
          document.getElementById(`catAgeMonths-${toIndex}`).value = fromMonths;
          document.getElementById(`catAgeDays-${toIndex}`).value = fromDays;

          calculateSpayNeuterDate(toIndex);
          generateEmail();
        }
      }

      function calculateSpayNeuterDate(catIndex) {
        const years =
          parseInt(document.getElementById(`catAgeYears-${catIndex}`).value) ||
          0;
        const months =
          parseInt(document.getElementById(`catAgeMonths-${catIndex}`).value) ||
          0;
        const days =
          parseInt(document.getElementById(`catAgeDays-${catIndex}`).value) ||
          0;

        if (years === 0 && months === 0 && days === 0) {
          document.getElementById(`spayNeuterDate-${catIndex}`).value = "";
          return;
        }

        const today = new Date();
        const birthDate = new Date(today);
        birthDate.setFullYear(birthDate.getFullYear() - years);
        birthDate.setMonth(birthDate.getMonth() - months);
        birthDate.setDate(birthDate.getDate() - days);

        const spayNeuterDate = new Date(birthDate);
        spayNeuterDate.setMonth(spayNeuterDate.getMonth() + 5);

        const formattedDate = spayNeuterDate.toISOString().split("T")[0];
        document.getElementById(`spayNeuterDate-${catIndex}`).value =
          formattedDate;
      }

      function toggleMicrochipInput(catIndex) {
        const checkbox = document.getElementById(`hasMicrochip-${catIndex}`);
        const inputContainer = document.getElementById(
          `microchipInputContainer-${catIndex}`
        );
        const input = document.getElementById(`microchipNumber-${catIndex}`);
        const searchButton = document.getElementById(
          `searchButton-${catIndex}`
        );

        if (checkbox.checked) {
          inputContainer.style.display = "block";
          input.focus();
          toggleSearchButton(catIndex);
        } else {
          inputContainer.style.display = "none";
          input.value = "";
          if (searchButton) {
            searchButton.disabled = true;
          }
          // Reset microchip company selections
          const radioButtons = document.getElementsByName(
            `microchipCompany-${catIndex}`
          );
          radioButtons.forEach((radio) => (radio.checked = false));
          document.getElementById(`otherCompanyName-${catIndex}`).value = "";
          document.getElementById(
            `otherCompanyName-${catIndex}`
          ).style.display = "none";
        }
      }

      function toggleOtherCompanyInput(catIndex) {
        const radioButton = document.getElementById(`otherCompany-${catIndex}`);
        const input = document.getElementById(`otherCompanyName-${catIndex}`);

        if (radioButton.checked) {
          input.style.display = "block";
          input.focus();
        } else {
          input.style.display = "none";
          input.value = "";
        }
      }

      function toggleSearchButton(catIndex) {
        const input = document.getElementById(`microchipNumber-${catIndex}`);
        const searchButton = document.getElementById(
          `searchButton-${catIndex}`
        );

        if (input && searchButton) {
          const hasValue = input.value.trim().length > 0;
          searchButton.disabled = !hasValue;
        }
      }

      function searchMicrochip(catIndex) {
        const input = document.getElementById(`microchipNumber-${catIndex}`);
        const microchipNumber = input.value.trim();

        if (microchipNumber) {
          // Get current date in the format "Aug Tue, 2025"
          const now = new Date();
          const months = [
            "Jan",
            "Feb",
            "Mar",
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
          ];
          const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

          const month = months[now.getMonth()];
          const day = days[now.getDay()];
          const year = now.getFullYear();
          const dateString = `${month}%20${day},%20${year}`;

          // Construct the search URL
          const searchUrl = `https://www.aaha.org/for-veterinary-professionals/microchip-search/?microchip_id=${encodeURIComponent(
            microchipNumber
          )}&date=${dateString}`;

          // Open in new tab
          window.open(searchUrl, "_blank");
        }
      }

      function getAllCats() {
        const cats = [];
        for (let i = 0; i < catCount; i++) {
          const catSection = document.getElementById(`cat-${i}`);
          if (catSection) {
            const name =
              document.getElementById(`catName-${i}`)?.value ||
              `[Cat ${i + 1} Name]`;
            const gender = document.getElementById(`catGender-${i}`)?.value;
            const years =
              parseInt(document.getElementById(`catAgeYears-${i}`)?.value) || 0;
            const months =
              parseInt(document.getElementById(`catAgeMonths-${i}`)?.value) ||
              0;
            const days =
              parseInt(document.getElementById(`catAgeDays-${i}`)?.value) || 0;
            const spayNeuterDate = document.getElementById(
              `spayNeuterDate-${i}`
            )?.value;
            const hasTattoo =
              document.getElementById(`hasTattoo-${i}`)?.checked || false;
            const hasMicrochip =
              document.getElementById(`hasMicrochip-${i}`)?.checked || false;
            const microchipNumber =
              document.getElementById(`microchipNumber-${i}`)?.value || "";

            // Get microchip company info
            const selectedCompany = document.querySelector(
              `input[name="microchipCompany-${i}"]:checked`
            );
            const smartTag = selectedCompany?.value === "smartTag";
            const bcPetRegistry = selectedCompany?.value === "bcPetRegistry";
            const otherCompany = selectedCompany?.value === "other";
            const otherCompanyName =
              document.getElementById(`otherCompanyName-${i}`)?.value || "";

            const ageInMonths = years * 12 + months + days / 30;
            let category = "adult";
            if (ageInMonths <= 5) {
              category = "young-kitten";
            } else if (ageInMonths > 5 && ageInMonths < 12) {
              category = "old-kitten";
            }

            cats.push({
              name,
              gender,
              ageInMonths,
              category,
              spayNeuterDate,
              hasTattoo,
              hasMicrochip,
              microchipNumber,
              microchipCompany: {
                smartTag,
                bcPetRegistry,
                otherCompany,
                otherCompanyName,
              },
              pronoun:
                gender === "female"
                  ? "her"
                  : gender === "male"
                  ? "his"
                  : "their",
              pronounCap:
                gender === "female"
                  ? "Her"
                  : gender === "male"
                  ? "His"
                  : "Their",
              catPronoun:
                gender === "female" ? "she" : gender === "male" ? "he" : "they",
            });
          }
        }
        return cats;
      }

      // New function to generate the vet continuation sentence
      function generateVetContinuationSentence(cats) {
        const kittens = cats.filter((cat) => cat.category !== "adult");
        const adults = cats.filter((cat) => cat.category === "adult");

        // If all cats are adults
        if (kittens.length === 0) {
          if (cats.length === 1) {
            // Single adult cat
            return `You are welcome to, but there is no obligation for you to continue to attend this vet after ${cats[0].pronoun} PACU.`;
          } else {
            // Multiple adult cats
            return `You are welcome to, but there is no obligation for you to continue to attend this vet after their PACU.`;
          }
        }

        // If all cats are kittens
        if (adults.length === 0) {
          let surgeryText = "";

          if (kittens.length === 1) {
            // Single kitten
            const kitten = kittens[0];
            const procedure =
              kitten.gender === "female"
                ? "spay"
                : kitten.gender === "male"
                ? "neuter"
                : "spay/neuter";
            surgeryText = `${kitten.pronoun} PACU/${procedure} surgery`;
          } else {
            // Multiple kittens - need to determine surgery types
            const hasFemaleCats = kittens.some(
              (cat) => cat.gender === "female"
            );
            const hasMaleCats = kittens.some((cat) => cat.gender === "male");

            if (hasFemaleCats && hasMaleCats) {
              // Mixed gender kittens
              surgeryText = `their PACU/spay/neuter surgery`;
            } else if (hasFemaleCats && !hasMaleCats) {
              // Only female kittens
              surgeryText = `their PACU/spay surgery`;
            } else if (hasMaleCats && !hasFemaleCats) {
              // Only male kittens
              surgeryText = `their PACU/neuter surgery`;
            } else {
              // Unknown gender kittens
              surgeryText = `their PACU/spay/neuter surgery`;
            }
          }

          return `You are welcome to, but there is no obligation for you to continue to attend this vet after ${surgeryText}.`;
        }

        // Mixed adults and kittens
        let surgeryText = "";
        const hasFemaleCats = kittens.some((cat) => cat.gender === "female");
        const hasMaleCats = kittens.some((cat) => cat.gender === "male");

        if (hasFemaleCats && hasMaleCats) {
          // Mixed gender kittens
          surgeryText = `their PACU/spay/neuter surgery`;
        } else if (hasFemaleCats && !hasMaleCats) {
          // Only female kittens
          surgeryText = `their PACU/spay surgery`;
        } else if (hasMaleCats && !hasFemaleCats) {
          // Only male kittens
          surgeryText = `their PACU/neuter surgery`;
        } else {
          // Unknown gender kittens
          surgeryText = `their PACU/spay/neuter surgery`;
        }

        return `You are welcome to, but there is no obligation for you to continue to attend this vet after ${surgeryText}.`;
      }

      function toggleTattooLink(catIndex) {
        const checkbox = document.getElementById(`hasTattoo-${catIndex}`);
        const linkDiv = document.getElementById(`tattooLink-${catIndex}`);
        if (!checkbox || !linkDiv) return;
        linkDiv.style.display = checkbox.checked ? "block" : "none";
      }

      function generateEmail() {
        const adopterName =
          document.getElementById("adopterName").value || "[Adopter Name]";
        const cats = getAllCats();

        if (cats.length === 0) return;

        const pacuDate = document.getElementById("pacuDate").value;
        const vaccineDate = document.getElementById("vaccineDate").value;

        const includeHealth = document.getElementById("healthSection").checked;
        const includeIdentification = document.getElementById(
          "identificationSection"
        ).checked;
        const includeInsurance =
          document.getElementById("insuranceSection").checked;
        const includeFacebook =
          document.getElementById("facebookSection").checked;

        const catNames = cats.map((cat) => cat.name).join(" and ");
        const hasKittens = cats.some((cat) => cat.category !== "adult");

        let email = `<p style="margin: 0 0 16px 0;">Hi ${adopterName},</p><p style="margin: 0 0 16px 0;">It's been a couple of weeks since you brought your new arrival home, and I hope everything is going well with ${catNames}! I am reaching out with a couple of reminders and to see if you have any questions since the adoption.</p>`;

        if (includeHealth) {
          email += `<p style="margin: 0 0 16px 0;"><strong style="font-weight: bold;">Health Related</strong></p>`;

          if (pacuDate) {
            const pacuDateObj = new Date(pacuDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            pacuDateObj.setHours(0, 0, 0, 0);

            const catSubject =
              cats.length > 1 ? `${catNames}'` : `${cats[0].name}'s`;

            if (pacuDateObj >= today) {
              email += `<p style="margin: 0 0 16px 0;">Please make sure you have booked ${catSubject} Post Adoption Checkup (PACU) with one of our partner vets, for a date on or before <strong style="font-weight: bold; color: #6f42c1;">${formatDate(
                pacuDate
              )}</strong>.</p><p style="margin: 0 0 16px 0;">You will be asked to provide the Contract (Agreement) and Medical History for the PACU (sent during the contract meeting from ShelterLuv). Ask the vet if they would prefer these electronically or (hard copy) in person. To avoid any cost to you, it is critical to provide these 2 documents to the vet, at the PACU.</p>`;
            } else {
              email += `<p style="margin: 0 0 16px 0;">I hope you were able to attend the Post Adoption Checkup (PACU) on <strong style="font-weight: bold; color: #6f42c1;">${formatDate(
                pacuDate
              )}</strong> with one of our partner vets and that all is well.</p>`;
            }
          }

          if (hasKittens) {
            if (vaccineDate) {
              const vaccineDateObj = new Date(vaccineDate + "T00:00:00");
              const today = new Date();
              today.setHours(0, 0, 0, 0);
              vaccineDateObj.setHours(0, 0, 0, 0);

              const kittens = cats.filter((cat) => cat.category !== "adult");
              const kittenText = kittens.length > 1 ? "kittens" : "kitten";
              const possessiveText = kittens.length > 1 ? "kittens'" : "kitten's";

              if (vaccineDateObj >= today) {
                email += `<p>Kitten vaccine protocol: kittens require 2 FVRCP vaccines, spaced one month apart. Your ${possessiveText} next vaccine is due: <strong style="font-weight: bold; color: #6f42c1;">${formatDate(
                  vaccineDate
                )}</strong>. This will be at your cost.</p>`;
              } else {
                email += `<p>Kitten vaccine protocol: kittens require 2 FVRCP vaccines, spaced one month apart. Your ${possessiveText} second vaccine was due: <strong style="font-weight: bold; color: #6f42c1;">${formatDate(
                  vaccineDate
                )}</strong>, at your cost.</p>`;
              }
            }

            const kittens = cats.filter((cat) => cat.category !== "adult");
            if (kittens.length > 0) {
              let surgeryText = "";
              if (kittens.length === 1) {
                // Single kitten
                const kitten = kittens[0];
                const procedure =
                  kitten.gender === "female"
                    ? "spay"
                    : kitten.gender === "male"
                    ? "neuter"
                    : "spay/neuter";
                surgeryText = `Your kitten will need ${kitten.pronoun} ${procedure}, tattoos (if applicable) and microchip insertion completed at the same partner vet that you attended for ${kitten.pronoun} PACU; cost is covered by adoption fees. `;
              } else {
                // Multiple kittens
                surgeryText = `Your kittens will need their spay/neuter, tattoos (if applicable) and microchip insertion completed at the same partner vet that you attended for their PACU; cost is covered by adoption fees. `;
              }

              // Check if it's a pair and determine timing
              if (cats.length === 2) {
                const genders = cats.map((cat) => cat.gender);
                if (genders.includes("male") && genders.includes("female")) {
                  surgeryText += `VOKRA policy states with a male-female pair, this should be done at <strong style="font-weight: bold; color: #6f42c1;">4 - 4.5 months of age</strong>; `;
                } else if (genders[0] === genders[1]) {
                  surgeryText += `VOKRA policy states with a same gender pair, this should be done at 5 months of age; `;
                }
              }

              // Determine the ending message based on gender composition
              const hasFemaleCats = kittens.some(
                (cat) => cat.gender === "female"
              );

              if (hasFemaleCats) {
                // Has female cats (single female or mixed gender group)
                surgeryText += `This avoids unwanted pregnancies, and prevents other mating behaviours from occurring.`;
              } else {
                // Only male cats (single male or all males)
                surgeryText += `This avoids other mating behaviours from occurring.`;
              }

              email += `<p>${surgeryText}</p>`;

              // Show spay/neuter age ranges for pairs
              if (cats.length === 2 && kittens.length === 2) {
                const genders = cats.map((cat) => cat.gender);
                const hasSpayNeuterDate = kittens.some(
                  (cat) => cat.spayNeuterDate
                );

                if (hasSpayNeuterDate) {
                  if (genders.includes("male") && genders.includes("female")) {
                    // Male-female pair: 4 - 4.5 months
                    const firstDate = new Date(kittens[0].spayNeuterDate);
                    firstDate.setMonth(firstDate.getMonth() - 1); // Subtract 1 month for 4 months
                    const secondDate = new Date(firstDate);
                    secondDate.setDate(secondDate.getDate() + 14); // Add 2 weeks for 4.5 months range

                    email += `<p>Your kittens will be <strong style="font-weight: bold; color: #6f42c1;">4 - 4.5 months of age: ${formatDate(
                      firstDate.toISOString().split("T")[0]
                    )} to ${formatDate(
                      secondDate.toISOString().split("T")[0]
                    )}</strong>. Please note some partner vets may push back on the 4 mos of age. They know our policy, and as long as the kittens are of sufficient weight to undergo the anesthetic, they can go ahead with the surgery.</p>`;
                  } else if (genders[0] === genders[1]) {
                    // Same gender pair: show 5 months date
                    email += `<p>Your kittens will be 5 months of age on: <strong style="font-weight: bold; color: #6f42c1;">${formatDate(
                      kittens[0].spayNeuterDate
                    )}</strong>. Please note some partner vets may push back on the 4 mos of age. They know our policy, and as long as the kittens are of sufficient weight to undergo the anesthetic, they can go ahead with the surgery.</p>`;
                  }
                }
              } else {
                // Single kitten or multiple kittens (not a pair)
                let ageText = "";
                if (kittens.length === 1) {
                  // Single kitten
                  const kitten = kittens[0];
                  if (kitten.spayNeuterDate) {
                    ageText = `Your kitten will be 5 months of age on: <strong style="font-weight: bold; color: #6f42c1;">${formatDate(
                      kitten.spayNeuterDate
                    )}</strong>.`;
                  }
                } else {
                  // Multiple kittens (not a pair)
                  const ageTexts = [];
                  kittens.forEach((cat) => {
                    if (cat.spayNeuterDate) {
                      ageTexts.push(`${cat.name} will be 5 months of age on: <strong style="font-weight: bold; color: #6f42c1;">${formatDate(cat.spayNeuterDate)}</strong>`);
                    }
                  });
                  if (ageTexts.length > 0) {
                    ageText = ageTexts.join("<br>");
                  }
                }
                if (ageText) {
                  ageText += " Please note some partner vets may push back on the 4 mos of age. They know our policy, and as long as the kittens are of sufficient weight to undergo the anesthetic, they can go ahead with the surgery.";
                  email += `<p>${ageText}</p>`;
                }
              }
            }
          }

          // Updated vet continuation sentence using the new function
          email += `<p>${generateVetContinuationSentence(cats)}</p>`;
        }

        if (includeIdentification) {
          email += `<p><strong style="font-weight: bold;">Identification</strong></p>`;

          // Check if any cat has tattoo
          const hasTattooedCats = cats.some((cat) => cat.hasTattoo);
          // Check if any cat has microchip
          const hasMicrochippedCats = cats.some((cat) => cat.hasMicrochip);

          if (hasTattooedCats) {
            // Updated per request: exact wording
            email += `<p>If you haven't already done so, please contact *** Animal Hospital at 604(phone number). *** where the tattoo was completed to change ownership of your kitty.</p>`;
          }

          if (hasMicrochippedCats) {
            // Check if any cat has SmartTag selected
            const hasSmartTagCats = cats.some(
              (cat) => cat.hasMicrochip && cat.microchipCompany.smartTag
            );
            // Check if any cat has BC Pet Registry or Other company
            const hasBCPetRegistryOrOtherCats = cats.some(
              (cat) =>
                cat.hasMicrochip &&
                (cat.microchipCompany.bcPetRegistry ||
                  cat.microchipCompany.otherCompany)
            );

            // Different text based on microchip company selection
            if (hasSmartTagCats && !hasBCPetRegistryOrOtherCats) {
              // Only SmartTag cats
              email += `<p>Our microchip provider SmartTag, will send you an email <strong style="font-weight: bold; color: #6f42c1;">within 6 weeks of their surgery</strong> to ask you to set up an account. There is no cost for this, but it will be your method to keep your contact info up to date (see microchip program page sent during the contract meeting).</p>`;

              const kittyText =
                cats.length === 1 ? "your kitty's" : `${catNames}'s`;
              email += `<p>Please ensure ${kittyText} identification registration is always kept current. In the unlikely event they go missing, they can be returned to you as soon as possible via their tattoo and/or their microchip.</p>`;
              email += `<p>If your contact information should change in the future please contact:<br>- The vet who completed the spay/neuter and who has the tattoo database;<br>- The microchip provider (refer to your cat's Medical History document)</p>`;
            } else if (hasBCPetRegistryOrOtherCats) {
              // Has BC Pet Registry or Other company cats
              const bcPetRegistryCats = cats.filter(
                (cat) => cat.hasMicrochip && cat.microchipCompany.bcPetRegistry
              );
              const otherCompanyCats = cats.filter(
                (cat) => cat.hasMicrochip && cat.microchipCompany.otherCompany
              );

              if (bcPetRegistryCats.length > 0) {
                let pronoun;
                if (bcPetRegistryCats.length === 1) {
                  const cat = bcPetRegistryCats[0];
                  if (cat.gender === "female") {
                    pronoun = "her";
                  } else if (cat.gender === "male") {
                    pronoun = "his";
                  } else {
                    pronoun = "the";
                  }
                } else {
                  pronoun = "their";
                }
                email += `<p>The microchip provider BC Pet Registry has been advised of ${pronoun} change of ownership. If you need to contact them, please visit: https://www.bcpetregistry.ca<br>or call: 855-622-7722 (Business Hours), 866-303-5950 (After Hours).</p>`;
              }

              if (otherCompanyCats.length > 0) {
                otherCompanyCats.forEach((cat) => {
                  if (cat.microchipCompany.otherCompanyName) {
                    email += `<p>The microchip provider ${cat.microchipCompany.otherCompanyName} has been advised of ${cat.pronoun} change of ownership.</p>`;
                  }
                });
              }

              const kittyText =
                cats.length === 1 ? "your kitty's" : `${catNames}'s`;
              email += `<p>Please ensure ${kittyText} identification registration is always kept current. In the unlikely event they go missing, they can be returned to you as soon as possible via their tattoo and/or their microchip.</p>`;

              if (bcPetRegistryCats.length > 0) {
                email += `<p>If your contact information should change in the future please contact:<br>- BC Pet Registry, who completed the spay and who has the tattoo database as well as the microchip information.</p>`;
              } else {
                // Only other companies
                email += `<p>If your contact information should change in the future please contact:<br>- The vet who completed the spay/neuter and who has the tattoo database;<br>- The microchip provider (refer to your cat's Medical History document)</p>`;
              }
            } else {
              // Mixed SmartTag and BC Pet Registry/Other - use generic text
              const kittyText =
                cats.length === 1 ? "your kitty's" : `${catNames}'s`;
              email += `<p>Please ensure ${kittyText} identification registration is always kept current. In the unlikely event they go missing, they can be returned to you as soon as possible via their tattoo and/or their microchip.</p>`;
              email += `<p>If your contact information should change in the future please contact:<br>- The vet who completed the spay/neuter and who has the tattoo database;<br>- The microchip provider (refer to your cat's Medical History document)</p>`;
            }
          } else {
            // No microchip selected - use SmartTag default text
            email += `<p>Our microchip provider SmartTag, will send you an email <strong style="font-weight: bold; color: #6f42c1;">within 6 weeks of their surgery</strong> to ask you to set up an account. There is no cost for this, but it will be your method to keep your contact info up to date (see microchip program page sent during the contract meeting).</p>`;

            email += `<p>Please ensure ${catNames}'s identification registration is always kept current. In the unlikely event they go missing, they can be returned to you as soon as possible via their tattoo and/or microchip.</p>`;
            email += `<p>If your contact information should change in the future please contact:<br>- The vet who completed the spay/neuter and who has the tattoo database;<br>- The microchip provider (refer to your cat's Medical History document)</p>`;
          }
        }

        if (includeInsurance) {
          email += `<p><strong style="font-weight: bold;">Insurance</strong></p>`;
          email += `<p>${catNames} may qualify for a free trial pet insurance with PetSecure. If you had previously indicated an interest in insurance, please read the information sent to you. If you are now interested, please let me know and I can send you the information. If you wish to enrol, please complete the form and bring it with you to our partner vet during the PACU. The vet will activate the insurance on your behalf.</p>`;
        }

        email += `<p>Feel free to reach out directly to adoptersupport@vokra.ca for any cat behaviour or other non-emergency questions.</p>`;

        if (includeFacebook) {
          email += `<p>Join VOKRA Alumni on Facebook (<a href="https://www.facebook.com/groups/557083514316555" target="_blank" rel="noopener">VOKRA ALUMNI | Facebook</a>) and post photos of ${catNames}!</p>`;
        }

        email += `<p>Thank you for giving ${catNames} a loving and fur-ever home!</p>`;

        // Set innerHTML instead of textContent to support HTML formatting
        document.getElementById("output").innerHTML = email;
      }

      function formatDate(dateString) {
        if (!dateString) return "[Date]";
        const date = new Date(dateString + "T00:00:00");
        const months = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];

        const day = date.getDate();
        const month = months[date.getMonth()];
        const suffix =
          day === 1 || day === 21 || day === 31
            ? "st"
            : day === 2 || day === 22
            ? "nd"
            : day === 3 || day === 23
            ? "rd"
            : "th";

        return `${month} ${day}${suffix}`;
      }

      function copyToClipboard() {
        const output = document.getElementById("output");
        
        // Create a range and select the output content
        const range = document.createRange();
        const selection = window.getSelection();
        
        // Clear any existing selection
        selection.removeAllRanges();
        
        // Select the output content
        range.selectNodeContents(output);
        selection.addRange(range);
        
        try {
          // Use the browser's native copy command
          const successful = document.execCommand('copy');
          
          // Clear the selection
          selection.removeAllRanges();
          
          if (successful) {
            const success = document.getElementById("copySuccess");
            success.textContent = "Formatted email copied to clipboard! ‚úÖ";
            success.classList.add("show");
            setTimeout(() => {
              success.classList.remove("show");
            }, 3000);
          } else {
            throw new Error('Copy command failed');
          }
        } catch (err) {
          // Clear selection on error
          selection.removeAllRanges();
          
          const success = document.getElementById("copySuccess");
          success.textContent = "Please manually select and copy the text above.";
          success.style.color = "#dc3545";
          success.classList.add("show");
          setTimeout(() => {
            success.classList.remove("show");
            success.style.color = "#28a745";
          }, 5000);
        }
      }

      // Auto-generate when key inputs change
      document
        .getElementById("adopterName")
        .addEventListener("input", generateEmail);

      // Initialize with first cat
      document.addEventListener("DOMContentLoaded", function () {
        addCat(); // Add the first cat section
      });
    </script>
  </body>
</html>